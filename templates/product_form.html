{% extends 'base.html' %}

{% block 'Body' %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header bg-card-header py-3">
                    <h3 class="mb-0">{{ title }}</h3>
                    <p class="text-muted mb-0">Manage your product listing details</p>
                </div>
                <div class="card-body p-4 p-lg-5">
                    <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <div class="row g-4">
                            <!-- Product Information Column -->
                            <div class="col-md-6">
                                <div class="section-card mb-4">
                                    <h4 class="section-title mb-4">Product Information</h4>
                                    
                                    <!-- Title Input -->
                                    <div class="form-floating mb-3">
                                        {{ form.title }}
                                        <label for="id_title">Product Title</label>
                                    </div>
                                    
                                    <!-- Description Input -->
                                    <div class="form-floating mb-3">
                                        {{ form.description }}
                                        <label for="id_description">Description</label>
                                    </div>
                                    
                                    <!-- Condition Input -->
                                    <div class="form-floating mb-3">
                                        {{ form.condition }}
                                        <label for="id_condition">Condition</label>
                                    </div>
                                    
                                    <!-- Images Upload -->
                                    <div class="mb-4">
                                        <label class="form-label">Product Images</label>
                                        <div class="file-input-wrapper border rounded p-3">
                                            <!-- Display existing images if editing -->
                                            {% if form.instance.pk and form.instance.images.all %}
                                            <div class="existing-images mb-3">
                                                <p class="form-text">Current Images:</p>
                                                <div class="row g-2">
                                                    {% for img in form.instance.images.all %}
                                                    <div class="col-4 col-md-3">
                                                        <div class="position-relative">
                                                            <img src="{{ img.image.url }}" class="img-thumbnail" alt="Product image">
                                                            {% if img.is_primary %}
                                                            <span class="badge bg-primary position-absolute top-0 end-0">Primary</span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                <p class="form-text mt-2">Upload new images to replace existing ones, or leave empty to keep current images.</p>
                                            </div>
                                            {% endif %}
                                            
                                            {{ form.images }}
                                            <div class="form-text text-muted">
                                                Upload multiple images (max 5 images, first image will be primary)
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Pricing & Availability Column -->
                            <div class="col-md-6">
                                <div class="section-card mb-4">
                                    <h4 class="section-title mb-4">Pricing & Availability</h4>
                                    
                                    <!-- Price Input -->
                                    <div class="form-floating mb-3">
                                        <input type="text" name="formatted_price" 
                                               class="form-control {% if form.formatted_price.errors %}is-invalid{% endif %}" 
                                               id="id_formatted_price" 
                                               placeholder="â‚¦ 0" 
                                               value="{{ form.formatted_price.value|default:'' }}">
                                        <label for="id_formatted_price">Price</label>
                                        {% for error in form.formatted_price.errors %}
                                            <div class="invalid-feedback d-block">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                    
                                    <!-- Listing Type -->
                                    <div class="form-floating mb-3">
                                        {{ form.listing_type }}
                                        <label  for="id_listing_type">Listing Type</label>
                                    </div>
                                    
                                    <!-- Quantity Input -->
                                    <div class="form-floating mb-3">
                                        {{ form.quantity }}
                                        <label for="id_quantity">Quantity</label>
                                    </div>
                                    
                                    <!-- Always Available -->
                                    <div class="form-check form-switch mb-4">
                                        {{ form.is_always_available }}
                                        <label class="form-check-label" for="id_is_always_available">
                                            Always Available
                                        </label>
                                    </div>
                                </div>

                                <!-- Categories & Branding -->
                                <div class="section-card">
                                    <h4 class="section-title mb-4">Categories & Branding</h4>
                                    
                                    <!-- Category Input -->
                                    <div class="form-floating mb-3">
                                        {{ form.category }}
                                        <label for="id_category">Category</label>
                                    </div>
                                    
                                    <!-- Subcategory Input -->
                                    <div class="form-floating mb-3">
                                        {{ form.subcategory }}
                                        <label for="id_subcategory">Subcategory</label>
                                    </div>
                                    
                                    <!-- Brand Input -->
                                    <div class="form-floating mb-3">
                                        {{ form.brand }}
                                        <label for="id_brand">Brand</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">{{ save }}</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .form-control, .form-select {
        border-width: 2px;
        border-style: solid;
        border-color: var(--border-color);
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px rgba(184, 115, 51, 0.2);
    }

    .form-check-input {
        border-width: 2px;
        border-color: var(--border-color);
    }

    .form-check-input:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    /* File Input Styling */
    .file-input-wrapper {
        background-color: var(--card-background);
        border-radius: var(--radius-md);
    }

    .file-input-wrapper input[type="file"] {
        border: none;
        background: transparent;
    }

    /* Dark Theme Adjustments */
    [data-bs-theme="dark"] {
        .form-control:focus, .form-select:focus {
            box-shadow: 0 0 0 3px rgba(205, 127, 50, 0.2);
        }

        .file-input-wrapper {
            background-color: var(--dark-card-background);
        }
    }

    /* Form Text */
    .form-text {
        font-size: 0.8rem;
        margin-top: 0.25rem;
        color: var(--text-secondary) !important;
        padding-left: 0.5rem;
    }
</style>

<!-- Keep existing JavaScript for dynamic dropdowns and price formatting -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const categorySelect = document.getElementById('id_category');
        const subcategorySelect = document.getElementById('id_subcategory');
        const brandSelect = document.getElementById('id_brand');
    
        // Update subcategories when category changes
        categorySelect.addEventListener('change', function() {
            const categoryId = this.value;
            subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
            brandSelect.innerHTML = '<option value="">Select Brand</option>';
    
            if (categoryId) {
                fetch(`/ajax/load-subcategories/?category=${categoryId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(subcategory => {
                            const option = document.createElement('option');
                            option.value = subcategory.id;
                            option.textContent = subcategory.name;
                            subcategorySelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error loading subcategories:', error));
            }
        });
    
        // Update brands when subcategory changes
        subcategorySelect.addEventListener('change', function() {
            const subcategoryId = this.value;
            brandSelect.innerHTML = '<option value="">Select Brand</option>';
    
            if (subcategoryId) {
                fetch(`/ajax/load-brands/?subcategory=${subcategoryId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(brand => {
                            const option = document.createElement('option');
                            option.value = brand.id;
                            option.textContent = brand.name;
                            brandSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error loading brands:', error));
            }
        });
    
        // Price formatting
        const priceInput = document.getElementById('id_formatted_price');
        if (priceInput) {
            const formatPrice = (value) => {
                value = value.replace(/[^\d]/g, '');
                if (value) {
                    value = parseInt(value, 10);
                    return 'â‚¦ ' + value.toLocaleString('en-NG');
                }
                return '';
            };
    
            priceInput.addEventListener('input', (e) => {
                e.target.value = formatPrice(e.target.value);
            });
    
            priceInput.addEventListener('blur', (e) => {
                e.target.value = formatPrice(e.target.value);
            });
        }

        const imageField = document.querySelector('input[name="images"]');
        if (imageField) {
            imageField.addEventListener('change', function() {
                const maxFiles = 5;
                const maxSize = 5 * 1024 * 1024; // 5MB
                const validTypes = ['image/jpeg', 'image/jpg', 'image/png'];
                const files = this.files;
                
                // Check number of files
                if (files.length > maxFiles) {
                    alert(`You can only upload a maximum of ${maxFiles} images. Only the first ${maxFiles} will be used.`);
                }
                
                // Check each file
                let hasError = false;
                for (let i = 0; i < Math.min(files.length, maxFiles); i++) {
                    const file = files[i];
                    
                    // Check file size
                    if (file.size > maxSize) {
                        alert(`Image "${file.name}" is too large (${(file.size/1024/1024).toFixed(2)}MB). Maximum size is 5MB.`);
                        hasError = true;
                        break;
                    }
                    
                    // Check file type
                    if (!validTypes.includes(file.type)) {
                        alert(`File "${file.name}" is not a supported format. Only JPG, JPEG or PNG files are allowed.`);
                        hasError = true;
                        break;
                    }
                }
                
                if (hasError) {
                    this.value = ''; // Clear the input
                }
            });
        }
    });
</script>
{% endblock %}
{% block 'Footer'%}{% endblock %}