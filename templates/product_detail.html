
{% extends 'base.html' %}

{% block 'Body' %}
<div class="card product-detail-card">
    <div class="product-detail-container">
        <div class="row g-4">
            <!-- Product Images Column -->
            <div class="col-md-6">
                <!-- Main Carousel -->
                <div class="main-carousel-wrapper">
                    <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-inner rounded-3 shadow-sm">
                            {% for image in images %}
                                <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                    <img src="{{ image.image.url }}" 
                                         class="d-block w-100 carousel-main-img" 
                                         alt="{{ product.title }}">
                                </div>
                            {% endfor %}
                        </div>
                        {% if images|length > 1 %}
                            <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                        {% endif %}
                    </div>
                </div>

                <!-- Thumbnail Navigation -->
                <div class="thumbnail-gallery mt-2">
                    <div class="row g-2">
                        {% for image in images %}
                            <div class="col-3">
                                <div class="thumbnail-wrapper">
                                    <img src="{{ image.image.url }}" 
                                         class="img-thumbnail {% if forloop.first %}active{% endif %}"
                                         alt="{{ product.title }}"
                                         data-bs-target="#productCarousel" 
                                         data-bs-slide-to="{{ forloop.counter0 }}"
                                         role="button">
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Product Details Column -->
            <div class="col-md-6">
                <div class="card border-0 h-100 product-details">
                    <div class="card-body p-0">
                        <!-- Product Header -->
                        <div class="product-header">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb small">
                                    <li class="breadcrumb-item">{{ product.category.name }}</li>
                                    <li class="breadcrumb-item">{{ product.subcategory.name }}</li>
                                    <li class="breadcrumb-item active">{{ product.brand.name }}</li>
                                </ol>
                            </nav>
                            <h1 class="product-title h2">{{ product.title }}</h1>
                            <div class="price-badge">
                                <span class="h3 mb-0 fw-bold text-primary">{{ formatted_price }}.00</span>
                            </div>
                        </div>

                        <!-- Product Info Grid -->
                        <div class="product-info-grid">
                            <div class="info-item">
                                <span class="label">Condition</span>
                                <span class="value">{{ product.get_condition_display }}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Listed</span>
                                <span class="value">{{ time_since_creation }}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Date</span>
                                <span class="value">{{ created_at|date:"F d, Y" }}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Views</span>
                                <span class="value"><i class="fas fa-eye me-1"></i>{{ product.view_count }}</span>
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="product-description">
                            <h5 class="fw-bold mb-2">Description</h5>
                            <div class="description-content">
                                {{ product.description|linebreaks }}
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        {% if user == product.seller.user %}
                            <div class="action-buttons">
                                <div class="d-flex gap-2">
                                    <a href="{% url 'product_update' product.id %}" class="btn btn-outline-primary flex-grow-1">
                                        <i class="fas fa-edit me-2"></i>Edit
                                    </a>
                                    <a href="{% url 'product_delete' product.id %}" class="btn btn-outline-danger flex-grow-1">
                                        <i class="fas fa-trash me-2"></i>Delete
                                    </a>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Seller Information Card -->
{% if user != product.seller.user %}
    <div class="card seller-card border-0 shadow-sm mt-3 mb-4">
        <div class="card-header border-0 bg-gradient py-2">
            <h5 class="mb-0 text-primary fw-bold">
                <i class="fas fa-user-circle me-2"></i>Seller Information
            </h5>
        </div>
        <div class="card-body py-3">
            <!-- Seller Profile Section -->
            <div class="d-flex flex-row align-items-center gap-3 mb-3">
                <div class="seller-avatar-wrapper">
                    {% if product.seller.user.profile.photo %}
                        <img src="{{ product.seller.user.profile.photo.url }}" 
                             alt="{{ product.seller.user.username }}" 
                             class="seller-avatar1">
                    {% else %}
                        <div class="seller-avatar-placeholder">
                            <span class="h5 mb-0">{{ product.seller.user.username|make_list|first|upper }}</span>
                        </div>
                    {% endif %}
                </div>
                
                <div class="seller-info">
                    <h5 class="fw-bold mb-1">{{ product.seller.user.username }}</h5>
                    <div class="rating-wrapper mb-1">
                        <div class="d-flex align-items-center gap-1">
                            <div class="stars">
                                {% with ''|center:product.average_rating|make_list as stars %}
                                {% for _ in stars %}
                                    <i class="fas fa-star text-warning"></i>
                                {% endfor %}
                                {% endwith %}
                                {% with ''|center:5|make_list as empty_stars %}
                                {% for _ in empty_stars %}
                                    {% if forloop.counter > product.average_rating %}
                                        <i class="far fa-star text-warning"></i>
                                    {% endif %}
                                {% endfor %}
                                {% endwith %}
                            </div>
                            <span class="rating-value fw-semibold small">
                                {{ product.average_rating|floatformat:1 }}/5
                            </span>
                        </div>
                    </div>
                    <p class="text-muted bio-text small mb-0">
                        {{ product.seller.user.profile.bio|default:"No bio provided"|truncatechars:100 }}
                    </p>
                </div>
            </div>
    
            <!-- Seller Details -->
            <div class="seller-details">
                <div class="row g-2">
                    <div class="col-12 col-md-6">
                        <div class="detail-item py-2">
                            <i class="fas fa-calendar-alt text-primary"></i>
                            <div class="ms-2">
                                <small class="text-muted">Member Since</small>
                                <span class="fw-medium small d-block">{{ product.seller.user.date_joined|date:"F d, Y" }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-6">
                        <div class="detail-item py-2">
                            <i class="fas fa-map-marker-alt text-primary"></i>
                            <div class="ms-2">
                                <small class="text-muted">Location</small>
                                <span class="fw-medium small d-block">
                                    {{ product.seller.location.address }}, 
                                    {{ product.seller.location.district }}, 
                                    {{ product.seller.location.state }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-3 d-flex gap-2">
                <a href="{% url 'user_store' username=product.seller.user.username %}" class="btn btn-secondary w-100 w-md-auto">
                    <i class="fas fa-store me-2"></i> Visit Store
                </a>
                <button class="btn btn-primary w-100 w-md-auto"
                        data-bs-toggle="modal"
                        data-bs-target="#contactSellerModal">
                    <i class="fas fa-envelope me-2"></i> Contact Seller
                </button>
            </div>
        </div>
    </div>
    {% endif %}
 
<!-- Safety Tips Card -->
<div class="card border-warning mb-3 mt-3">
    <div class="card-header bg-warning text-dark">
      <h5 class="mb-0">
        <i class="fas fa-exclamation-triangle me-2"></i>Safety Tips
      </h5>
    </div>
    <div class="card-body">
      <h6 class="card-title">To avoid scams, please follow these guidelines:</h6>
      <div class="scam-guidelines-container">
        <ul class="list-group list-group-flush" id="safety-tips">

        <span class="fw-small small ">


          <li class="list-group-item">
              <i class="fas fa-check-circle text-success me-2"></i>Meet in a well-lit, public place for transactions preferrably seller's store if possessed
          </li>
          <li class="list-group-item">
              <i class="fas fa-check-circle text-success me-2"></i>Inspect the item thoroughly and be sure of the seller's ownership before purchasing
          </li>
          <li class="list-group-item">
            <i class="fas fa-times-circle text-danger me-2"></i>Never send money or goods before receiving payment
          </li>

          <div id="hidden-tips" class="collapse">
                    <li class="list-group-item">
                        <i class="fas fa-check-circle text-success me-2"></i>Only send money directly to affirmed seller's bank info, not to delivery man or middleman
                    </li>
                    <li class="list-group-item">
                        <i class="fas fa-check-circle text-success me-2"></i>Confirm Seller's Bank details before sending
                    </li>
                    <li class="list-group-item">
                        <i class="fas fa-check-circle text-success me-2"></i>Bring a friend or family member when meeting for high-value transactions
                    </li>
                    <li class="list-group-item">
                        <i class="fas fa-check-circle text-success me-2"></i>Verify the seller's identity before making a purchase
                    </li>
                    <li class="list-group-item">
                        <i class="fas fa-times-circle text-danger me-2"></i>Don't share personal financial information
                    </li>
                    <li class="list-group-item">
                        <i class="fas fa-check-circle text-success me-2"></i>Trust your instincts - if a deal seems too good to be true, it probably is
                    </li>
                    <li class="list-group-item">
                        <i class="fas fa-check-circle text-success me-2"></i>Keep all transaction records and communications
                    </li>
                </div>
            </ul>
            <button class="btn btn-link text-primary mt-2 d-flex align-items-center" 
            data-bs-toggle="collapse" 
            data-bs-target="#hidden-tips" 
            aria-expanded="false"
            id="toggle-tips">
            <span class="toggle-text fw-medium small">See more safety tips</span>
            <i class="fas fa-chevron-down ms-1 toggle-icon"></i>
        </button>
    </div>
    <div class="mt-3">
        <p class="mb-0 fw-medium small"><strong class=" Medium">Remember:</strong> Your safety is our priority. If you encounter any suspicious activity, please report it immediately to our support team.</p>
    </div>
</span>
</div>
</div>

<!--Reviews Form Card-->
{% include 'reviews_section.html' %}

<!--Related Products-->
<div class="mt-4 container-fluid">
    <h2 class="section-title text-center mb-4">Related Products</h2>
    <div class="row g-3">
    {% for related_product in related_products %}
    <div class="col-6 col-sm-4 col-md-3 col-lg product-column">
            {% include 'product_card.html' with product=related_product %}
        </div>
    {% empty %}
        <p>No related products found.</p>
    {% endfor %}
   </div>
         
<!--Contact View Modal -->
<div class="modal fade" id="contactSellerModal" tabindex="-1" aria-labelledby="contactSellerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="contactSellerModalLabel">Seller Contact Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Seller:</strong> <span id="sellerName">{{ product.seller.user.username }}</span></p>
                <p><strong>Phone Number:</strong> 
                    <span id="sellerPhone">{{ product.seller.phone_number }}</span>
                    <i class="fas fa-copy" id="copyPhoneIcon" style="cursor: pointer;" title="Copy Phone Number"></i>
                </p>
                <p><strong>Address:</strong> 
                    <span id="sellerAddress">{{ product.seller.location.address }}, {{ product.seller.location.address_2 }}, {{ product.seller.location.district }}, {{ product.seller.location.state }}.</span>
                </p>
            </div>
            <div class="modal-footer">
                <a id="whatsappLink" href="#" class="btn btn-success" target="_blank">WhatsApp</a>
                <a id="phoneLink" href="#" class="btn btn-primary">Call</a>
                <a class="btn btn-primary" href="{% url 'send_message' product.id %}">Send Inbox</a>
            </div>
        </div>
    </div>
</div>

<style>
    .collapse:not(.show) {
        display: none;
    }
    
    #toggle-tips[aria-expanded="true"] .toggle-icon {
        transform: rotate(180deg);
        transition: transform 0.2s ease;
    }
    
    #toggle-tips[aria-expanded="false"] .toggle-icon {
        transform: rotate(0deg);
        transition: transform 0.2s ease;
    }
    
    #toggle-tips {
        text-decoration: none;
        padding: 0;
    }
    .seller-card {
        background: #ffffff;
        transition: all 0.3s ease;
    }
    
    .seller-card:hover {
        transform: translateY(-2px);
    }
    
    .seller-card .card-header {
        background: linear-gradient(to right, #f8f9fa, #ffffff);
    }
    
    .seller-avatar-wrapper {
        position: relative;
        flex-shrink: 0;
    }
    
    .seller-avatar1,
    .seller-avatar-placeholder {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: 2px solid #fff;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .seller-avatar {
        object-fit: cover;
    }
    
    .seller-avatar-placeholder {
        background: linear-gradient(45deg, #6c757d, #495057);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .rating-wrapper .stars {
        display: inline-flex;
        gap: 1px;
        font-size: 0.9rem;
    }
    
    .bio-text {
        line-height: 1.3;
    }
    
    .detail-item {
        display: flex;
        align-items: flex-start;
        padding: 0.5rem;
        background: #f8f9ed;
        border-radius: 6px;
        height: 100%;
    }
    
    .detail-item i {
        font-size: 1rem;
        margin-top: 2px;
    }
    
    @media (min-width: 768px) {
        .w-md-auto {
            width: auto !important;
        }
    }
    /* Container Styles */
.product-detail-container {
    max-width: 1200px;
    margin: 0 auto;
}

/* Carousel Styles */
.main-carousel-wrapper {
    position: relative;
    background: #f8f9fa;
    border-radius: 0.5rem;
}

.carousel-main-img {
    aspect-ratio: 2/2;
    object-fit: contain;
    background: #f8f9fa;
    transition: transform 0.3s ease; /* Smooth transitions for zoom */
}


/* Thumbnail Gallery */
.thumbnail-wrapper {
    position: relative;
    aspect-ratio: 1;
    cursor: pointer;
    overflow: hidden;
}

.thumbnail-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.2s;
}

.thumbnail-wrapper img:hover {
    transform: scale(1.05);
}

.thumbnail-wrapper img.active {
    border-color: #0d6efd;
}

/* Product Details */

.product-detail-card {
    padding: 0.5rem;
}

.product-details {
    height: 100%;
    background: transparent;
}

.product-header {
    margin-bottom: 0.5rem;
}

.breadcrumb {
    margin-bottom: 0.5rem;
    padding: 0;
}

.price-badge {
    display: inline-block;
    padding: 0.25rem 0;
    background: #f8f9fa;
    border-radius: 0.5rem;
    margin-bottom: 0.75rem;
}

/* Info Grid */
.product-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 0.4rem;
    margin-bottom: 0.75rem;
}

.info-item {
    padding: 0.35rem;
    background: #f8f9fa;
    border-radius: 0.5rem;
}

.info-item .label {
    display: block;
    font-size: 0.7rem;
    color: #6c757d;
    margin-bottom: 0.1rem;
}

.info-item .value {
    display: block;
    font-weight: 500;
    color: #2c3e50;
    font-size: 0.9rem;
}

/* Description */
.product-description {
    margin-bottom: 1rem;
}

.description-content {
    font-size: 0.9rem;
    line-height: 1.1;
    color: #4a5568;
    max-height: 100px; /* Set a maximum height */
    overflow-y: auto; /* Enable vertical scrolling */
    padding-right: 10px; /* Add padding for scrollbar space */
}

/* Action Buttons */
.action-buttons {
    margin-top: 0.75rem;
}

/* Responsive Adjustments */
@media (max-width: 767.98px) {
    .product-title {
        font-size: 1.5rem;
    }
    
    .product-info-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}
</style>
<script>
    // Wait for DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Contact Seller Modal functionality
        const contactSellerModal = document.getElementById('contactSellerModal');
        if (contactSellerModal) {
            contactSellerModal.addEventListener('show.bs.modal', function (event) {
                const sellerPhone = "{{ product.seller.phone_number }}";
                const whatsappLink = document.getElementById('whatsappLink');
                const phoneLink = document.getElementById('phoneLink');
    
                if (sellerPhone) {
                    // Clean phone number and add country code if needed
                    let cleanPhone = sellerPhone.replace(/\D/g,'');
                    if (!cleanPhone.startsWith('234')) {
                        cleanPhone = '234' + cleanPhone;
                    }
    
                    whatsappLink.href = 'https://wa.me/' + cleanPhone;
                    phoneLink.href = 'tel:' + sellerPhone;
    
                    whatsappLink.classList.remove('disabled');
                    phoneLink.classList.remove('disabled');
    
                    // Add click event listeners
                    whatsappLink.addEventListener('click', function() {
                        console.log('WhatsApp link clicked. URL:', this.href);
                    });
    
                    phoneLink.addEventListener('click', function() {
                        console.log('Phone link clicked. URL:', this.href);
                    });
                } else {
                    whatsappLink.href = '#';
                    phoneLink.href = '#';
                    whatsappLink.classList.add('disabled');
                    phoneLink.classList.add('disabled');
                    console.error('Phone number is not available');
                }
            });
        }
    
        // Star Rating functionality
        const ratingSelect = document.getElementById('rating');
        if (ratingSelect) {
            const starRating = document.createElement('div');
            starRating.classList.add('star-rating');
    
            ratingSelect.parentNode.insertBefore(starRating, ratingSelect);
            ratingSelect.style.display = 'none';
    
            // Create stars
            for (let i = 1; i <= 5; i++) {
                const star = document.createElement('span');
                star.innerHTML = '&#9734;'; // Empty star
                star.addEventListener('click', () => {
                    ratingSelect.value = i;
                    updateStars();
                });
                starRating.appendChild(star);
            }
    
            function updateStars() {
                const stars = starRating.children;
                for (let i = 0; i < stars.length; i++) {
                    stars[i].innerHTML = i < ratingSelect.value ? '&#9733;' : '&#9734;';
                }
            }
    
            ratingSelect.addEventListener('change', updateStars);
            updateStars();
        }
    
        // Copy Phone Number functionality
        const copyPhoneIcon = document.getElementById('copyPhoneIcon');
        if (copyPhoneIcon) {
            copyPhoneIcon.addEventListener('click', function() {
                const phoneNumber = document.getElementById('sellerPhone')?.textContent.trim();
                if (phoneNumber) {
                    navigator.clipboard.writeText(phoneNumber)
                        .then(() => alert('Phone number copied to clipboard!'))
                        .catch(err => console.error('Failed to copy: ', err));
                }
            });
        }
    
        // Safety Tips Toggle functionality
        const hiddenTips = document.getElementById('hidden-tips');
        const toggleText = document.getElementById('toggle-text');
        if (hiddenTips && toggleText) {
            hiddenTips.addEventListener('show.bs.collapse', function () {
                toggleText.textContent = 'Show less';
            });
    
            hiddenTips.addEventListener('hide.bs.collapse', function () {
                toggleText.textContent = 'See more safety tips';
            });
        }
    });
    </script>
{% endblock %}
{% block 'Footer'%}{% endblock %}