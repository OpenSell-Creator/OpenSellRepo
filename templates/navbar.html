{% load static %}

<!-- Upper nav - can auto-hide on mobile only -->
<nav class="navbar navbar-expand-lg custom-navbar fixed-top" id="mainNavbar">
  <div class="container-fluid">
    
    <a class="navbar-brand" href="{% url 'home' %}">
      <img src="{% static 'images/logodark.png' %}" alt="OpenSell" height="40" class="d-inline-block align-text-top">
    </a>

    <!-- Desktop search form - visible only on desktop -->
    <div class="navbar-nav flex-grow-1 justify-content-center order-lg-1 d-none d-lg-flex">
      <form class="d-flex search-form" action="{% url 'product_search' %}" method="get">
        <div class="input-group">
          <input type="text" class="form-control rounded-pill" placeholder="Find anything on OpenSell" aria-label="Search" name="query">
          <button class="btn btn-outline-light rounded-pill" type="submit">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.3-4.3"></path>
            </svg>
          </button>
        </div>
      </form>
    </div>
    
    <!-- Desktop Navigation -->
    <div class="d-flex align-items-center order-lg-2">
      <div class="navbar-nav d-none d-lg-flex">
      {% if user.is_authenticated %}
      <ul class="navbar-nav mb-2 mb-lg-0">
        <li class="nav-item d-none d-lg-block text-center">
          <a class="nav-link {% if request.resolver_match.url_name == 'saved_products' %}active{% endif %}" href="{% url 'saved_products' %}">
            <!-- Always using outlined bookmark icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
            </svg>
            <div class="nav-text">Saved</div>
          </a>
        </li>

        <li class="nav-item d-none d-lg-block text-center">
          <a class="nav-link position-relative {% if request.resolver_match.url_name == 'inbox' %}active{% endif %}" href="{% url 'inbox' %}">
            <!-- Always using outlined message icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21.2 8.4c.5.38.8.97.8 1.6v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V10a2 2 0 0 1 .8-1.6l8-6a2 2 0 0 1 2.4 0l8 6Z"/>
              <path d="m22 10-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 10"/>
            </svg>
            {% if unread_messages_count > 0 %}
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger notification-badge">
                {{ unread_messages_count }}
              </span>
            {% endif %}
            <div class="nav-text">Messages</div>
          </a>
        </li>

        <li class="nav-item d-none d-lg-block text-center">
          <a class="nav-link position-relative {% if request.resolver_match.url_name == 'list' and request.resolver_match.namespace == 'notifications' %}active{% endif %}" href="{% url 'notifications:list' %}">
            <!-- Always using outlined notification icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"></path>
              <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"></path>
              <path d="M4 2C2.8 3.7 2 5.7 2 8"></path>
              <path d="M22 8c0-2.3-.8-4.3-2-6"></path>
            </svg>
            {% if unread_notifications_count > 0 %}
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger notification-badge">
              {{ unread_notifications_count }}
            </span>
            {% endif %}
            <div class="nav-text">Notifications</div>
          </a>
        </li>

        <li class="nav-item d-none d-lg-block text-center">
          <a class="nav-link {% if request.resolver_match.url_name == 'profile_menu' %}active{% endif %}" href="{% url 'profile_menu' %}">
            {% if user.profile.photo %}
              <img src="{{ user.profile.photo.url }}" alt="Profile Photo" class="img-fluid rounded-circle profile-photo-nav">
            {% else %}
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
            {% endif %}
            <div class="nav-text">Profile</div>
          </a>
        </li>
      </ul>
      
      {% else %}
      <div class="d-flex align-items-center">
        <a href="/login" class="btn btn-outline-light btn-sm me-2">Sign In</a>
        <a href="/register" class="btn btn-light btn-sm">Sign Up</a>
      </div>
      {% endif %}
    </div>
  </div>

<!-- Hamburger Menu Button (Right-aligned) -->
    <button class="navbar-toggler d-lg-none ms-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#mainSidebar" aria-controls="mainSidebar" aria-label="Toggle navigation">
      <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="4" x2="20" y1="12" y2="12"/>
        <line x1="4" x2="20" y1="6" y2="6"/>
        <line x1="4" x2="20" y1="18" y2="18"/>
      </svg>
    </button>
  </div>
</nav>

<!-- Off-canvas Sidebar -->
<div class="offcanvas offcanvas-end custom-sidebar" tabindex="-1" id="mainSidebar" aria-labelledby="mainSidebarLabel">
  <div class="offcanvas-body">
    <!-- Close button at the top of the body -->
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close" data-bs-target="#bdNavbar"></button>
    
    <!-- Search in Sidebar - Updated with unique classes -->
    <div class="sidebar-search-container mb-4">
      <form class="sidebar-search-form" action="{% url 'product_search' %}" method="get">
        <div class="input-group">
          <input type="text" class="form-control sidebar-search-input rounded-pill" placeholder="Find anything" aria-label="Search" name="query">
          <button class="btn sidebar-search-button rounded-pill" type="submit">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.3-4.3"></path>
            </svg>
          </button>
        </div>
      </form>
    </div>
    
    {% if user.is_authenticated %}
      <!-- Categories Section -->
      <div class="mb-4">
        <h6 class="sidebar-heading text-uppercase">Categories</h6>
        <div class="list-group list-group-flush categories-list">
          <a href="{% url 'product_list' %}" class="list-group-item border-0 d-flex align-items-center">
            <div class="category-icon2 me-2 rounded-circle1 d-flex align-items-center justify-content-center">
              <i class="bi bi-grid-fill text-white"></i>
            </div>
            All Products
          </a>
          
          {% for category in global_categories %}
            <div class="list-group-item border-0 {% if category.id == selected_category %}active{% endif %}">
              <div class="d-flex justify-content-between align-items-center">
                <a href="{% url 'product_list' %}?category={{ category.slug }}"
                   class="text-decoration-none category-link d-flex align-items-center">
                  {% if category.image %}
                    <img src="{{ category.image.url }}" alt="{{ category.name }}" class="category-image me-2 rounded-circle">
                  {% else %}
                    <div class="category-icon me-2 rounded-circle d-flex align-items-center justify-content-center">
                      <i class="bi bi-folder-fill text-white"></i>
                    </div>
                  {% endif %}
                  {{ category.name }}
                  <span class="category-count small ms-2 mb-0">
                    ({{ category.product_count }})
                  </span>
                </a>
                {% if category.subcategories.all %}
                  <button class="btn btn-link p-0 category-toggle"
                          data-bs-toggle="collapse"
                          data-bs-target="#category{{ category.id }}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="m6 9 6 6 6-6"/>
                    </svg>
                  </button>
                {% endif %}
              </div>
              
              {% if category.subcategories.all %}
                <div class="collapse {% if category.id == selected_category %}show{% endif %}" id="category{{ category.id }}">
                  <div class="ps-3 mt-2">
                    {% for subcategory in category.subcategories.all %}
                      <a href="{% url 'product_list' %}?category={{ category.slug }}&subcategory={{ subcategory.slug }}"
                         class="d-block text-decoration-none subcategory-link mb-2 d-flex align-items-center {% if subcategory.id == selected_subcategory %}active-subcategory{% endif %}">
                        {% if subcategory.image %}
                          <img src="{{ subcategory.image.url }}" alt="{{ subcategory.name }}" class="subcategory-image me-2 rounded-circle">
                        {% else %}
                          <div class="subcategory-icon me-2 rounded-circle d-flex align-items-center justify-content-center">
                            <i class="bi bi-folder text-white" style="font-size: 0.8rem;"></i>
                          </div>
                        {% endif %}
                        {{ subcategory.name }}
                        <span class="category-count small ms-2 mb-0">
                          ({{ subcategory.product_count }})
                        </span>
                      </a>
                    {% endfor %}
                  </div>
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
    {% else %}
      <!-- Authentication Section -->
      <div class="auth-section text-center p-4">
        <h6 class="mb-4">Join Our Marketplace</h6>
        <div class="d-grid gap-3">
          <a href="/login" class="btn btn-outline-primary btn-lg">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
              <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
              <polyline points="10 17 15 12 10 7"/>
              <line x1="15" y1="12" x2="3" y2="12"/>
            </svg>
            Sign In
          </a>
          <a href="/register" class="btn btn-primary btn-lg">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
              <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <line x1="19" y1="8" x2="19" y2="14"/>
              <line x1="16" y1="11" x2="22" y2="11"/>
            </svg>
            Sign Up
          </a>
        </div>
      </div>
    {% endif %}
  </div>
</div>

<!-- Mobile Bottom Navigation -->
{% if user.is_authenticated %}
<nav class="navbar fixed-bottom navbar-dark d-lg-none bottom-nav" id="bottomNav">
  <div class="container-fluid justify-content-around">
    <a class="nav-link text-center {% if request.resolver_match.url_name == 'home' %}active{% endif %}" href="{% url 'home' %}">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
        <path d="M9 22V12h6v10"></path>
      </svg>
      <div class="nav-text">Home</div>
    </a>
    
    <a class="nav-link text-center position-relative {% if request.resolver_match.url_name == 'inbox' %}active{% endif %}" href="{% url 'inbox' %}">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21.2 8.4c.5.38.8.97.8 1.6v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V10a2 2 0 0 1 .8-1.6l8-6a2 2 0 0 1 2.4 0l8 6Z"></path>
        <path d="m22 10-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 10"></path>
      </svg>
      {% if unread_messages_count > 0 %}
      <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger notification-badge">
        {{ unread_messages_count }}
      </span>
      {% endif %}
      <div class="nav-text">Messages</div>
    </a>
    <a class="nav-link text-center {% if request.resolver_match.url_name == 'saved_products' %}active{% endif %}" href="{% url 'saved_products' %}">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
      </svg>
      <div class="nav-text">Saved</div>
    </a>
    <a class="nav-link text-center {% if request.resolver_match.url_name == 'list' and request.resolver_match.namespace == 'notifications' %}active{% endif %}" href="{% url 'notifications:list' %}">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"></path>
        <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"></path>
        <path d="M4 2C2.8 3.7 2 5.7 2 8"></path>
        <path d="M22 8c0-2.3-.8-4.3-2-6"></path>
      </svg>
      {% if unread_notifications_count > 0 %}
        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger notification-badge">
            {{ unread_notifications_count }}
        </span>
      {% endif %}
      <div class="nav-text">Notifications</div>
    </a>
    <a class="nav-link text-center {% if request.resolver_match.url_name == 'profile_menu' %}active{% endif %}" href="{% url 'profile_menu' %}">
  {% if user.profile.photo %}
    <img src="{{ user.profile.photo.url }}" alt="Profile Photo" class="img-fluid rounded-circle profile-photo-small">
  {% else %}
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
      <circle cx="12" cy="7" r="4"></circle>
    </svg>
  {% endif %}
  <div class="nav-text">Profile</div>
</a>
  </div>
</nav>
{% endif %}

<style>
  /* Theme Colors */
  :root {
    --navbar-bg: var(--primary-color);
    --text-color: var(--card-background);
    --active-color: var(--secondary-color);
    --hover-color: var(--hover-bg);
    --border-color: var(--border-color);
    --search-bg: var(--card-background);
    --search-text: var(--text-primary);
    --badge-bg: var(--accent-color);
  }

  /* Navbar Styles */
  .custom-navbar, .bottom-nav {
    background-color: var(--navbar-bg);
    z-index: 1050;
    transition: transform 0.5s ease, opacity 0.5s ease;
    padding: 0.75rem 1.25rem; 
    will-change: opacity, transform;
    box-shadow: 0 4px 6px rgba(0,0,0,0.08);
  }
  
  .navbar-brand {
      margin-right: 0.5rem;
  }
  
  .navbar-brand img {
    height: 50px; 
    margin-right: 1rem;
  }

  /* Body padding adjustments */
  body {
    padding-top: 65px; 
    transition: padding-top 0.3s ease;
  }
  
  @media (min-width: 992px) {
    /* Desktop - account for navbar height */
    body {
      padding-top: var(--navbar-height);
      padding-bottom: 0;
      margin-bottom: var(--bottom-nav-height);
    }
    
    /* Prevent navbar from auto-hiding on desktop */
    .custom-navbar {
      transform: none !important;
      opacity: 1 !important;
    }
  }

  @media (min-width: 992px) {
      .order-lg-1 {
          order: 1;
      }
      .order-lg-2 {
          order: 2;
      }
  }
  
  @media (max-width: 991px) {
      .container-fluid {
        padding-right: 0.5rem;
        padding-left: 0.5rem;
      }
      
      .navbar-toggler {
        margin-left: 0.5rem;
      }
  }
  
  .d-flex.align-items-center {
    gap: 0.2rem;
  }
  

  /* Search Form Styles - keeping original */
  .search-form {
    max-width: 800px;
    margin: 0 auto;
    width: 100%;
  }
  
  .search-form .form-control {
      background-color: var(--search-bg);
      color: var(--search-text);
      border: 1px solid var(--border-color);
      padding: 0.6rem 1.2rem;
      font-size: 1rem;
      transition: all 0.3s ease;
  }
  
  .search-form .form-control:focus {
      box-shadow: 0 0 0 3px rgba(var(--active-color), 0.25);
  }
  
  .search-form .btn {
      background-color: var(--search-bg);
      color: var(--search-text);
      border: 1px solid var(--border-color);
      padding: 0.5rem 1rem;
      transition: all 0.3s ease;
  }
  
  /* Navigation Links */
  .nav-link {
      font-size: 1rem;
      margin: 0 10px;
      color: rgba(255, 255, 255, 0.7) !important;
      transition: color 0.2s ease, transform 0.2s ease;
      position: relative;
      padding: 0.5rem 1rem;
  }
  
  .nav-link:hover {
      color: rgba(255, 255, 255, 0.9) !important;
  }
  
  .nav-link.active {
      color: var(--accent-color) !important; 
      font-weight: 600; 
  }
  
  .nav-link svg {
    transition: transform 0.2s ease, stroke 0.2s ease;
      stroke: rgba(255, 255, 255, 0.7);
  }
  
  .nav-link:hover svg {
      stroke: rgba(255, 255, 255, 0.9);
      transform: scale(1.15);
  }
  
  .nav-link.active svg {
      stroke: var(--accent-color); 
  }
  
  
  .nav-link.active::after {
      display: none; 
  }
  
  /* Navigation Text */
  .nav-text {
      font-size: 0.5rem;
      margin-top: 2px;
      color: inherit;
  }

  /* Profile Photos */
  .profile-photo-nav {
      width: 36px;
      height: 36px;
      object-fit: cover;
      border: 2px solid #ffffff;
  }
  
  .profile-photo-small {
      width: 28px;
      height: 28px;
      object-fit: cover;
      border: 1px solid #ffffff;
  }
  
  .badge {
      font-size: 0.6rem;
      padding: 0.25em 0.6em;
      top: -8px;
      right: -8px;
      background-color: var(--accent-color); /* Themed color */
      color: white;
      font-weight: 600;
  }
  
  @media (max-width: 991px) {
      .bottom-nav {
          display: flex;
      }
      
      .navbar-nav {
          flex-direction: row;
      }
      
      .bottom-nav .nav-link {
          font-size: 1.3rem;
          margin: 0;
          padding: 5px;
      }
      
      body {
          padding-bottom: 70px; /* Space for bottom nav */
      }
  }
  
  @media (max-width: 576px) {
      .navbar-brand img {
          height: 38px; /* Even smaller on small screens */
      }
  }
  
  /* Offcanvas Sidebar Styling */
.custom-sidebar {
    max-width: 320px;
    width: 100%;
    padding-bottom: 40px;
    border-left: 1px solid var(--border-color);
    box-shadow: -5px 0 15px rgba(0, 0, 0, 0.05);
    background-color: var(--card-background);
}

.custom-sidebar .offcanvas-body {
    padding: 1.5rem;
}

/* Sidebar Header Styling */
.sidebar-heading {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 1rem;
    letter-spacing: 0.5px;
}

/* Search Bar Styling for Sidebar */
.sidebar-search-container {
    position: relative;
}

.sidebar-search-form {
    position: relative;
}

.sidebar-search-input {
    background-color: var(--card-background);
    color: var(--text-primary);
    border: 2px solid var(--primary-color);
    padding: 10px 16px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
}

.sidebar-search-input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.15);
}

.sidebar-search-button {
    color: var(--primary-color);
    height: 50px;
    border-color: var(--primary-color);
    transition: all 0.3s ease;
}

.sidebar-search-button:hover {
    background-color: var(--primary-color);
    color: #ffffff;
}

/* Categories List */
.categories-list {
    margin-left: -0.5rem;
    margin-right: -0.5rem;
}

.categories-list .list-group-item {
    background-color: transparent;
    transition: background-color 0.3s ease;
    border-radius: var(--radius-md);
    margin-bottom: 0.25rem;
    padding: 0.5rem;
}

.categories-list .list-group-item:hover {
    background-color: var(--hover-bg);
}

.categories-list .list-group-item.active {
    background-color: var(--primary-color) !important;
    color: #ffffff !important;
    border-color: var(--primary-color);
}

/* Category Link Styling */
.category-link {
    color: var(--text-primary);
    text-decoration: none;
    display: flex;
    align-items: center;
    font-weight: 500;
    transition: color 0.3s ease;
}

.list-group-item.active .category-link {
    color: #ffffff;
}

.category-link:hover {
    color: var(--primary-color);
}

.list-group-item.active .category-link:hover {
    color: #ffffff;
}

/* Category Count */
.category-count {
    color: var(--text-secondary);
    transition: color 0.3s ease;
}

.list-group-item.active .category-count {
    color: rgba(255, 255, 255, 0.8);
}

/* Category Icon */
.category-icon2 {
    width: 30px;
    height: 30px;
    background-color: var(--primary-color);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    margin-right: 0.75rem;
    transition: all 0.3s ease;
}

.category-icon2 i {
    color: #ffffff;
    font-size: 0.875rem;
}

.category-image {
    width: 30px;
    height: 30px;
    object-fit: cover;
    border-radius: 50%;
    margin-right: 0.75rem;
    transition: transform 0.3s ease;
}

.category-image:hover,
.subcategory-image:hover {
    transform: scale(1.1);
}

.notification-badge {
  font-size: 0.6rem;
  padding: 0.25em 0.6em;
  top: -8px;
  right: -8px;
  background-color: var(--accent-color, #dc3545);
  color: white;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1;
}

/* This will ensure the badge is properly positioned and visible */
.nav-link.position-relative {
  position: relative;
}
/* Toggle Button */
.category-toggle {
    color: var(--text-primary);
    transition: transform 0.3s ease, color 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    padding: 0;
    border-radius: 50%;
}

.category-toggle:hover {
    background-color: var(--hover-bg);
    color: var(--primary-color);
}

.list-group-item.active .category-toggle {
    color: #ffffff;
}

.category-toggle[aria-expanded="true"] svg {
    transform: rotate(180deg);
}

/* Subcategories */
.subcategory-link {
    color: var(--text-secondary);
    padding: 0.5rem 0.75rem;
    border-radius: var(--radius-md);
    transition: all 0.3s ease;
    text-decoration: none;
    margin-bottom: 0.25rem;
    font-size: 0.95rem;
}


.subcategory-link.active-subcategory {
    color: var(--primary-color);
    background-color: var(--hover-bg);
    font-weight: 500;
}

/* Fix for subcategory text color when parent category is active */
.list-group-item.active .subcategory-link {
    color: rgba(255, 255, 255, 0.9);
}

.list-group-item.active .subcategory-link:hover,
.list-group-item.active .subcategory-link.active-subcategory {
    background-color: rgba(255, 255, 255, 0.2);
    color: #ffffff;
}

.list-group-item.active .subcategory-link.active-subcategory {
    background-color: rgba(255, 255, 255, 0.3);
    border-left: 2px solid #ffffff;
}

/* Fix for subcategory count when parent category is active */
.list-group-item.active .subcategory-link .category-count {
    color: rgba(255, 255, 255, 0.7);
}

/* Subcategory Icons */
.subcategory-icon {
    width: 20px;
    height: 20px;
    background-color: var(--primary-color);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    margin-right: 0.75rem;
    transition: all 0.3s ease;
}

.subcategory-icon i {
    color: #ffffff;
    font-size: 0.75rem;
}

.subcategory-image {
    width: 20px;
    height: 20px;
    object-fit: cover;
    border-radius: 50%;
    margin-right: 0.75rem;
}

/* Fix for subcategory icons when parent is active */
.list-group-item.active .subcategory-icon {
    background-color: rgba(255, 255, 255, 0.3);
}

.list-group-item.active .subcategory-icon i {
    color: #ffffff;
}

/* Auth Section */
.auth-section {
    background-color: var(--hover-bg);
    border-radius: var(--radius-lg);
    margin-top: 1rem;
    margin-bottom: 1rem;
}

.auth-section h6 {
    color: var(--text-primary);
    font-weight: 600;
}

/* Animation for dropdown */
@media (prefers-reduced-motion: no-preference) {
    .collapse {
        transition: height 0.3s ease;
    }
}

/* Close button */
.btn-close {
  --bs-btn-close-color: #000;
  --bs-btn-close-bg: url(data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23000'%3e%3cpath d='M.293.293a1 1 0 0 1 1.414 0L8 6.586 14.293.293a1 1 0 1 1 1.414 1.414L9.414 8l6.293 6.293a1 1 0 0 1-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 0 1-1.414-1.414L6.586 8 .293 1.707a1 1 0 0 1 0-1.414'/%3e%3c/svg%3e);
  --bs-btn-close-opacity: 0.5;
  --bs-btn-close-hover-opacity: 0.75;
  --bs-btn-close-focus-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
  --bs-btn-close-focus-opacity: 1;
  --bs-btn-close-disabled-opacity: 0.25;
  box-sizing: content-box;
  width: 1em;
  height: 1em;
  padding: .25em .25em;
  color: var(--bs-btn-close-color);
  background: transparent var(--bs-btn-close-bg) center / 1em auto no-repeat;
  filter: var(--bs-btn-close-filter);
  border: 0;
  border-radius: .375rem;
  opacity: var(--bs-btn-close-opacity);
}

.btn-close-white {
  --bs-btn-close-filter: invert(1) grayscale(100%) brightness(200%);
}

.btn-close:hover {
    opacity: 1;
}

/* Responsive Adjustments */
@media (max-width: 576px) {
    .custom-sidebar {
        max-width: 100%;
    }
}
  
  .navbar-toggler {
      z-index: 1030;
      position: relative;
      border: none;
      padding: 0.25rem;
      color: var(--text-color);
  }
  
  .navbar-toggler:focus {
      box-shadow: none;
  }
  
  .navbar-toggler svg {
      stroke: var(--text-color);
  }


  /* Custom sidebar positioning */
.custom-sidebar {
  /* Position below navbar */
  top: calc(var(--navbar-height-mobile) + env(safe-area-inset-top));
  height: calc(100% - var(--navbar-height-mobile) - var(--bottom-nav-height));
  border-top: 1px solid var(--border-color);
}

/* Define navbar height variables */
:root {
  --navbar-height: 75px; /* Desktop navbar height */
  --navbar-height-mobile: 65px; /* Mobile navbar height */
}

/* Responsive adjustments */
@media (max-width: 991px) {
  .custom-sidebar {
    top: var(--navbar-height-mobile) !important;
    height: calc(100% - var(--navbar-height-mobile) - var(--bottom-nav-height)) !important;
  
  }
  
  body.sidebar-open {
    overflow: hidden;
  }
}

/* Adjust z-index to ensure proper layering */
.custom-sidebar {
  z-index: 1045; 
}

.custom-navbar {
  z-index: 1050; 
}

.bottom-nav {
  z-index: 1050; 
}
  

  .categories-list .list-group-item {
      background: transparent;
      padding: 0.5rem 0;
  }
  
  .category-link {
      color: var(--text-primary);
      font-weight: 500;
  }
  
  .subcategory-link {
      color: var(--text-secondary);
      font-size: 0.9rem;
      padding: 0.25rem 0;
  }
  
  .category-toggle {
      color: var(--text-secondary);
  }
  
  .category-toggle svg {
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  
  .category-toggle[aria-expanded="true"] svg {
      transform: rotate(-180deg);
  }
  
  .auth-section {
      margin-top: 2rem;
  }
  
  .auth-section .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.75rem 1.5rem;
  }
  
  .auth-section .btn svg {
    margin-right: 0.5rem;
  }

</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Get DOM elements
    const mainNavbar = document.getElementById('mainNavbar');
    const bottomNav = document.getElementById('bottomNav');
    
    // Get current URL path for active links
    const path = window.location.pathname;
    
    // Set active nav links based on current path
    document.querySelectorAll('.nav-link').forEach(link => {
      const href = link.getAttribute('href');
      if (href === path || (path.includes(href) && href !== '/')) {
        link.classList.add('active');
      }
    });
    
    // Category toggles animation
    const toggles = document.querySelectorAll('.category-toggle');
    toggles.forEach(toggle => {
      toggle.addEventListener('click', function(e) {
        // Don't prevent default as it would break the collapse functionality
        const icon = this.querySelector('svg');
        // Animation is handled by CSS
      });
    });
  
    // Enhanced scroll behavior for navbar hiding - Mobile Only
    if (window.innerWidth < 992) {
      let lastScroll = 0;
      
      window.addEventListener('scroll', () => {
        const currentScroll = window.scrollY;
        
        // Hide navbar when scrolling down
        if (currentScroll > lastScroll && currentScroll > 100) {
          mainNavbar.style.transform = 'translateY(-100%)';
          bottomNav.style.transform = 'translateY(100%)';
        } 
        // Show navbar when scrolling up
        else {
          mainNavbar.style.transform = 'translateY(0)';
          bottomNav.style.transform = 'translateY(0)';
        }
        
        lastScroll = currentScroll;
      });
    }
    
    // Handle search form submissions
    const searchForms = document.querySelectorAll('.search-form');
    searchForms.forEach(form => {
      form.addEventListener('submit', function(e) {
        const input = this.querySelector('input[name="query"]');
        if (!input.value.trim()) {
          e.preventDefault();
          input.focus();
        }
      });
    });
    
    // Close sidebar when clicking on a link (mobile)
    if (window.innerWidth < 992) {
      const sidebarLinks = document.querySelectorAll('#mainSidebar a:not(.dropdown-toggle)');
      const sidebar = document.getElementById('mainSidebar');
      
      sidebarLinks.forEach(link => {
        link.addEventListener('click', function() {
          const bsOffcanvas = bootstrap.Offcanvas.getInstance(sidebar);
          if (bsOffcanvas) {
            bsOffcanvas.hide();
          }
        });
      });
    }
    
    // Initialize Bootstrap components
    // Tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function(tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Popovers
    const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    popoverTriggerList.map(function(popoverTriggerEl) {
      return new bootstrap.Popover(popoverTriggerEl);
    });
    
    // Handle notifications badge visibility
    function updateNotificationsBadges() {
      const notificationBadges = document.querySelectorAll('.notification-badge');
      notificationBadges.forEach(badge => {
        // Get the count value and parse it as an integer
        const count = parseInt(badge.textContent.trim());
        
        // Only hide if count is 0 or NaN (not a number)
        if (isNaN(count) || count === 0) {
          badge.style.display = 'none';
        } else {
          badge.style.display = 'flex';
        }
      });
    }
    
    // Call initially
    updateNotificationsBadges();
    
    // Add a MutationObserver to watch for changes in notification badges
    // This ensures badges update if counts change dynamically
    const notificationBadges = document.querySelectorAll('.notification-badge');
    if (notificationBadges.length > 0) {
      const observer = new MutationObserver(updateNotificationsBadges);
      
      notificationBadges.forEach(badge => {
        observer.observe(badge, { 
          childList: true, 
          characterData: true,
          subtree: true 
        });
      });
    }
    
    // Theme toggle functionality (if implemented)
    const themeToggle = document.getElementById('themeToggle');
    if (themeToggle) {
      themeToggle.addEventListener('click', function() {
        const currentTheme = document.documentElement.getAttribute('data-bs-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-bs-theme', newTheme);
        localStorage.setItem('preferredTheme', newTheme);
        
        // Update toggle icon if needed
        const themeIcon = this.querySelector('svg.theme-icon');
        if (themeIcon) {
          if (newTheme === 'dark') {
            themeIcon.innerHTML = `<path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>`;
          } else {
            themeIcon.innerHTML = `<circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/>`;
          }
        }
      });
      
      // Set initial theme based on user preference
      const savedTheme = localStorage.getItem('preferredTheme');
      if (savedTheme) {
        document.documentElement.setAttribute('data-bs-theme', savedTheme);
        // Update toggle icon
        const themeIcon = themeToggle.querySelector('svg.theme-icon');
        if (themeIcon) {
          if (savedTheme === 'dark') {
            themeIcon.innerHTML = `<path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>`;
          } else {
            themeIcon.innerHTML = `<circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/>`;
          }
        }
      }
    }
    
    // Handle dropdown menu positioning
    const dropdownMenus = document.querySelectorAll('.dropdown-menu');
    dropdownMenus.forEach(menu => {
      const dropdown = menu.closest('.dropdown');
      if (dropdown) {
        dropdown.addEventListener('show.bs.dropdown', function() {
          // Adjust position for dropdowns near screen edges
          const rect = menu.getBoundingClientRect();
          if (rect.right > window.innerWidth) {
            menu.classList.add('dropdown-menu-end');
          }
        });
      }

      // Function to update the close button color based on the theme
      function updateCloseButtonColor() {
        const closeButton = document.querySelector('.offcanvas-header .btn-close');
        if (closeButton) {
          const theme = document.documentElement.getAttribute('data-bs-theme');
          if (theme === 'dark') {
            closeButton.style.filter = 'invert(1) grayscale(100%) brightness(200%)';
          } else {
            closeButton.style.filter = 'none';
            closeButton.style.color = 'var(--primary-color)';
          }
        }
      }

      // Call the function when the page loads and when the theme changes
      document.addEventListener('DOMContentLoaded', updateCloseButtonColor);
      document.addEventListener('change', updateCloseButtonColor);
    });

    document.addEventListener('DOMContentLoaded', function() {
      // Get sidebar element
      const sidebar = document.getElementById('mainSidebar');
      
      // Add event listeners for sidebar state
      sidebar.addEventListener('show.bs.offcanvas', function() {
        document.body.classList.add('sidebar-open');
      });
      
      sidebar.addEventListener('hide.bs.offcanvas', function() {
        document.body.classList.remove('sidebar-open');
      });
      
      // Make sure sidebar height adjusts if window is resized
      window.addEventListener('resize', function() {
        if (window.innerWidth >= 992) {
          // Reset any mobile-specific styles when switching to desktop
          sidebar.style.bottom = 'auto';
        }
      });
    });
  });
</script>