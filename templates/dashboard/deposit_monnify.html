{% extends "base.html" %}
{% load static %}

{% block title %}Fund Account - {{ block.super }}{% endblock %}

{% block 'Body' %}
<div class="container my-4">
    {% if has_virtual_account %}
    <script id="virtualAccountData" type="application/json">
    {
        "account_reference": "{{ virtual_accounts.first.account_reference }}",
        "account_name": "{{ virtual_accounts.first.account_name }}",
        "accounts": [
            {% for va in virtual_accounts %}
            {
                "bank_name": "{{ va.bank_name }}",
                "account_number": "{{ va.account_number }}",
                "bank_code": "{{ va.bank_code }}"
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
    }
    </script>
    {% endif %}

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-primary text-white py-3">
                    <h5 class="mb-0"><i class="bi bi-wallet2 me-2"></i>Fund Your Account</h5>
                </div>
            </div>

            <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>

            {% if has_virtual_account %}
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center py-3">
                        <h6 class="mb-0"><i class="bi bi-bank2 me-2"></i>Your Permanent Account</h6>
                        <span class="badge bg-light text-success">Active</span>
                    </div>
                    <div class="card-body p-4">
                        <div class="mb-3">
                            <label class="form-label text-muted small fw-bold">ACCOUNT NAME</label>
                            <input type="text" class="form-control bg-body-secondary border-0" value="{{ virtual_accounts.first.account_name }}" readonly>
                        </div>

                        <label class="form-label text-muted small fw-bold mb-2">TRANSFER TO ANY BANK</label>
                        {% for va in virtual_accounts %}
                        <div class="bank-card p-3 rounded mb-2">
                            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                <div class="flex-grow-1 min-w-0">
                                    <h6 class="mb-1 fw-bold text-body text-truncate">{{ va.bank_name }}</h6>
                                    <h5 class="mb-0 font-monospace text-primary">{{ va.account_number }}</h5>
                                </div>
                                <button class="btn btn-primary btn-sm flex-shrink-0" onclick="copyText(this, '{{ va.account_number }}')">
                                    <i class="bi bi-clipboard d-sm-none"></i>
                                    <span class="d-none d-sm-inline"><i class="bi bi-clipboard me-1"></i>Copy</span>
                                </button>
                            </div>
                        </div>
                        {% endfor %}

                        <div class="alert alert-light border mb-0 mt-3">
                            <small class="text-body-secondary">
                                <i class="bi bi-info-circle me-1"></i>
                                Transfer any amount to credit your wallet instantly
                            </small>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-body-secondary py-3" role="button" data-bs-toggle="collapse" data-bs-target="#oneTimeSection">
                        <h6 class="mb-0">
                            <i class="bi bi-lightning-charge-fill text-warning me-1"></i>One-Time Transfer
                            <i class="bi bi-chevron-down float-end"></i>
                        </h6>
                    </div>
                    <div id="oneTimeSection" class="collapse">
                        <div class="card-body p-4">
                            <div id="quickTransferForm">
                                <p class="text-muted small mb-3">Generate temporary account for single deposit</p>
                                <form onsubmit="generateQuickTransfer(event)">
                                    <div class="input-group mb-2">
                                        <span class="input-group-text">₦</span>
                                        <input type="number" class="form-control" id="quickAmount" name="amount" 
                                               min="100" max="5000000" step="100" placeholder="Enter amount" required>
                                        <button type="submit" class="btn btn-warning" id="generateBtn">
                                            <i class="bi bi-lightning-charge-fill me-1"></i>Generate
                                        </button>
                                    </div>
                                    <small class="text-muted">Min: ₦100 | Max: ₦5,000,000</small>
                                </form>
                            </div>
                            <div id="quickTransferDetails" style="display: none;"></div>
                        </div>
                    </div>
                </div>

            {% else %}
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body p-4">
                        <h6 class="mb-3"><i class="bi bi-lightning-charge-fill text-warning me-2"></i>Quick Transfer</h6>
                        <p class="text-muted small mb-3">Generate temporary account for single deposit</p>
                        
                        <div id="quickTransferForm">
                            <form onsubmit="generateQuickTransfer(event)">
                                <div class="input-group input-group-lg mb-2">
                                    <span class="input-group-text">₦</span>
                                    <input type="number" class="form-control" id="quickAmount" name="amount" 
                                           min="100" max="5000000" step="100" placeholder="Enter amount" required>
                                    <button type="submit" class="btn btn-warning" id="generateBtn">
                                        <i class="bi bi-lightning-charge-fill me-1"></i>Generate
                                    </button>
                                </div>
                                <small class="text-muted">Min: ₦100 | Max: ₦5,000,000</small>
                            </form>
                        </div>
                        <div id="quickTransferDetails" style="display: none;"></div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h6 class="mb-0">
                                <i class="bi bi-bank2 text-primary me-2"></i>Permanent Account
                            </h6>
                            <span class="badge bg-primary">Recommended</span>
                        </div>
                        <ul class="list-unstyled mb-3 small">
                            <li class="mb-1"><i class="bi bi-check-circle-fill text-success me-2"></i>One-time setup</li>
                            <li class="mb-1"><i class="bi bi-check-circle-fill text-success me-2"></i>Reusable anytime</li>
                            <li class="mb-1"><i class="bi bi-check-circle-fill text-success me-2"></i>Auto-credit deposits</li>
                        </ul>

                        <button class="btn btn-primary w-100 mb-3" data-bs-toggle="collapse" data-bs-target="#permanentForm">
                            <i class="bi bi-bank2 me-2"></i>Create Permanent Account
                        </button>

                        <div id="permanentForm" class="collapse">
                            <div class="alert alert-info border-info bg-info bg-opacity-10 mb-3 py-2">
                                <small>
                                    <i class="bi bi-shield-check me-1"></i>
                                    Required by Central Bank of Nigeria for account creation
                                </small>
                            </div>

                            <form onsubmit="createPermanentAccount(event)">
                                {% csrf_token %}

                                <div class="btn-group w-100 mb-3" role="group">
                                    <input type="radio" class="btn-check" name="verifyType" id="useBVN" value="bvn" checked>
                                    <label class="btn btn-outline-primary" for="useBVN">BVN</label>

                                    <input type="radio" class="btn-check" name="verifyType" id="useNIN" value="nin">
                                    <label class="btn btn-outline-primary" for="useNIN">NIN</label>

                                    <input type="radio" class="btn-check" name="verifyType" id="useBoth" value="both">
                                    <label class="btn btn-outline-primary" for="useBoth">Both</label>
                                </div>

                                <div id="bvnField" class="mb-3">
                                    <input type="text" class="form-control" id="bvn" name="bvn" 
                                           maxlength="11" pattern="[0-9]{11}" placeholder="Enter 11-digit BVN" required>
                                    <small class="text-muted d-block mt-1">
                                        <i class="bi bi-phone"></i> Dial *565*0# to get your BVN
                                    </small>
                                </div>

                                <div id="ninField" class="mb-3" style="display: none;">
                                    <input type="text" class="form-control" id="nin" name="nin" 
                                           maxlength="11" pattern="[0-9]{11}" placeholder="Enter 11-digit NIN">
                                </div>

                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="agreeTerms" required>
                                    <label class="form-check-label small" for="agreeTerms">
                                        I agree to share my BVN/NIN for verification
                                    </label>
                                </div>

                                <button type="submit" class="btn btn-primary w-100" id="createBtn">
                                    <i class="bi bi-bank2 me-2"></i>Create Account
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body text-center py-4">
                    <h6 class="text-muted mb-2 small">Current Balance</h6>
                    <h2 class="text-primary mb-0">₦{{ account.balance|floatformat:0 }}</h2>
                </div>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-header bg-body-secondary py-3">
                    <h6 class="mb-0"><i class="bi bi-lightbulb me-2"></i>How It Works</h6>
                </div>
                <div class="card-body p-3">
                    <div class="step-item">
                        <span class="step-num">1</span>
                        <div>
                            <strong class="d-block">Get Account</strong>
                            <small class="text-muted">Choose method</small>
                        </div>
                    </div>
                    <div class="step-item">
                        <span class="step-num">2</span>
                        <div>
                            <strong class="d-block">Transfer</strong>
                            <small class="text-muted">From any bank</small>
                        </div>
                    </div>
                    <div class="step-item">
                        <span class="step-num">3</span>
                        <div>
                            <strong class="d-block">Auto-Credit</strong>
                            <small class="text-muted">Instant credit</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="accountModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" id="accountModalContent">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="bi bi-clock-history me-2"></i>Active Transfer Account</h5>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>
</div>

<style>
.bank-card {
    background: var(--bs-body-bg);
    border: 1px solid var(--bs-border-color);
    transition: all 0.3s;
}

.bank-card:hover {
    background: var(--bs-secondary-bg);
    border-color: var(--bs-primary);
}

.min-w-0 {
    min-width: 0;
}

.bank-card .btn-sm {
    padding: 0.375rem 0.5rem;
    font-size: 0.875rem;
}

@media (max-width: 575.98px) {
    .bank-card .btn-sm {
        padding: 0.375rem 0.625rem;
    }
}

.step-item {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--bs-border-color);
}

.step-item:last-child {
    border-bottom: none;
}

.step-num {
    width: 32px;
    height: 32px;
    background: var(--bs-primary);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    flex-shrink: 0;
    font-size: 0.875rem;
}

.toast {
    min-width: 300px;
}

.countdown-timer {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--bs-warning);
}

.countdown-expired {
    color: var(--bs-danger);
}

.waiting-pulse {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.payment-success {
    animation: slideDown 0.5s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@media (max-width: 991.98px) {
    .modal-dialog {
        margin: 1rem;
    }
}
</style>

<script>
const State = {
    pollingInterval: null,
    currentTransactionRef: null,
    pollStartTime: null,
    countdownInterval: null,
    quickTransferActive: false,
    paymentProcessed: false,
    modalShown: false
};

document.addEventListener('DOMContentLoaded', function() {
    protectModalFromAlertSystem();
    initEventListeners();
    
    setTimeout(() => {
        restoreQuickTransferState();
        startGeneralPaymentCheck();
    }, 200);
});

function protectModalFromAlertSystem() {
    const modalEl = document.getElementById('accountModal');
    if (modalEl) {
        modalEl.setAttribute('data-no-auto-dismiss', 'true');
        
        const modalContent = document.getElementById('accountModalContent');
        if (modalContent) {
            modalContent.setAttribute('data-no-auto-dismiss', 'true');
        }
        
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList') {
                    const modalBody = document.getElementById('modalBody');
                    if (modalBody && State.quickTransferActive) {
                        const alerts = modalBody.querySelectorAll('[class*="alert"]');
                        alerts.forEach(alert => {
                            alert.setAttribute('data-persist', 'true');
                            alert.setAttribute('data-no-auto-dismiss', 'true');
                        });
                    }
                }
            });
        });
        
        observer.observe(modalEl, {
            childList: true,
            subtree: true
        });
    }
}

function initEventListeners() {
    document.querySelectorAll('input[name="verifyType"]').forEach(radio => {
        radio.addEventListener('change', toggleVerificationType);
    });
    
    window.addEventListener('beforeunload', cleanup);
}

function restoreQuickTransferState() {
    try {
        const savedState = sessionStorage.getItem('quickTransferState');
        if (!savedState) return;
        
        const state = JSON.parse(savedState);
        const now = Date.now();
        const elapsed = (now - state.startTime) / 1000;
        const remaining = (40 * 60) - elapsed;
        
        if (remaining > 0 && !state.completed) {
            State.quickTransferActive = true;
            State.currentTransactionRef = state.transactionRef;
            State.pollStartTime = state.startTime;
            
            const quickForm = document.getElementById('quickTransferForm');
            if (quickForm) {
                quickForm.style.display = 'none';
            }
            
            showAccountModal(state.transferData, Math.floor(remaining));
            
            setTimeout(() => {
                if (document.getElementById('countdown')) {
                    startCountdown(Math.floor(remaining));
                }
                startPaymentPolling(state.transactionRef);
            }, 300);
        } else {
            sessionStorage.removeItem('quickTransferState');
        }
    } catch (error) {
        console.error('Error restoring state:', error);
        sessionStorage.removeItem('quickTransferState');
    }
}

function saveQuickTransferState(transactionRef, transferData) {
    try {
        const state = {
            transactionRef: transactionRef,
            transferData: transferData,
            startTime: Date.now(),
            completed: false
        };
        sessionStorage.setItem('quickTransferState', JSON.stringify(state));
    } catch (error) {
        console.error('Error saving state:', error);
    }
}

function clearQuickTransferState() {
    try {
        sessionStorage.removeItem('quickTransferState');
    } catch (error) {
        console.error('Error clearing state:', error);
    }
}

function toggleVerificationType(event) {
    const bvnField = document.getElementById('bvnField');
    const ninField = document.getElementById('ninField');
    const bvnInput = document.getElementById('bvn');
    const ninInput = document.getElementById('nin');
    
    const type = event.target.value;
    
    if (type === 'bvn') {
        bvnField.style.display = 'block';
        ninField.style.display = 'none';
        bvnInput.required = true;
        ninInput.required = false;
        ninInput.value = '';
    } else if (type === 'nin') {
        bvnField.style.display = 'none';
        ninField.style.display = 'block';
        bvnInput.required = false;
        ninInput.required = true;
        bvnInput.value = '';
    } else {
        bvnField.style.display = 'block';
        ninField.style.display = 'block';
        bvnInput.required = true;
        ninInput.required = true;
    }
}

async function createPermanentAccount(event) {
    event.preventDefault();
    
    const form = event.target;
    const btn = document.getElementById('createBtn');
    const originalText = btn.innerHTML;
    
    const verifyType = form.querySelector('input[name="verifyType"]:checked').value;
    const bvn = form.querySelector('#bvn')?.value.trim() || '';
    const nin = form.querySelector('#nin')?.value.trim() || '';
    
    if ((verifyType === 'bvn' || verifyType === 'both') && !validateBVN(bvn)) {
        showToast('Valid BVN required (11 digits)', 'danger');
        return;
    }
    
    if ((verifyType === 'nin' || verifyType === 'both') && !validateNIN(nin)) {
        showToast('Valid NIN required (11 digits)', 'danger');
        return;
    }
    
    if (!document.getElementById('agreeTerms').checked) {
        showToast('Please agree to terms', 'warning');
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating...';
    
    try {
        const requestData = {};
        if (verifyType === 'bvn' || verifyType === 'both') requestData.bvn = bvn;
        if (verifyType === 'nin' || verifyType === 'both') requestData.nin = nin;
        
        const response = await fetch('/api/create-permanent-account/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(requestData)
        });
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Invalid server response');
        }
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            showToast('Account created successfully!', 'success');
            setTimeout(() => location.reload(), 2000);
        } else {
            showToast(data.message || 'Failed to create account', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Error: ' + error.message, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

async function generateQuickTransfer(event) {
    event.preventDefault();
    
    if (State.quickTransferActive) {
        showToast('Please wait for current transfer to complete or expire', 'warning');
        return;
    }
    
    const form = event.target;
    const amountInput = form.querySelector('#quickAmount');
    const btn = document.getElementById('generateBtn');
    const amount = parseFloat(amountInput.value);
    
    if (isNaN(amount) || amount < 100) {
        showToast('Minimum amount is ₦100', 'danger');
        return;
    }
    
    if (amount > 5000000) {
        showToast('Maximum amount is ₦5,000,000', 'danger');
        return;
    }
    
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    
    try {
        const response = await fetch('/api/generate-quick-transfer/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ amount: amount })
        });
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Invalid server response');
        }
        
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.message || 'Failed to generate account');
        }
        
        State.quickTransferActive = true;
        State.currentTransactionRef = data.transaction_reference;
        
        saveQuickTransferState(data.transaction_reference, data);
        
        showAccountModal(data, 40 * 60);
        document.getElementById('quickTransferForm').style.display = 'none';
        
        startPaymentPolling(data.transaction_reference);
        startCountdown(40 * 60);
        
        showToast('Transfer account generated!', 'success');
        
    } catch (error) {
        console.error('Error:', error);
        showToast('Error: ' + error.message, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

function showAccountModal(data, seconds) {
    const accounts = data.accounts || [];
    const amount = data.amount || 0;
    
    const minutes = Math.floor(seconds / 60);
    const secs = seconds % 60;
    const initialDisplay = `${minutes}:${secs.toString().padStart(2, '0')}`;
    
    let html = `
        <div class="alert alert-primary text-center mb-3" id="amountDisplay" data-persist="true">
            <h6 class="mb-1">Amount to Transfer</h6>
            <h2 class="mb-0">₦${parseFloat(amount).toLocaleString('en-NG', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}</h2>
        </div>
        
        <div id="countdownDisplay" class="alert alert-warning text-center mb-3" data-persist="true">
            <i class="bi bi-clock me-1"></i> Expires in: <span class="countdown-timer" id="countdown">${initialDisplay}</span>
        </div>
    `;
    
    if (accounts.length > 0) {
        html += `
            <div class="mb-3" id="accountNameDisplay" data-persist="true">
                <label class="form-label text-muted small fw-bold">ACCOUNT NAME</label>
                <input type="text" class="form-control bg-body-secondary border-0" value="${data.account_name}" readonly>
            </div>
        `;
        
        accounts.forEach((acc, index) => {
            html += `
                <div class="bank-card p-3 rounded mb-2" id="bankCard${index}" data-persist="true">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div class="flex-grow-1 min-w-0">
                            <h6 class="mb-1 text-body text-truncate">${acc.bankName || acc.bank_name}</h6>
                            <h5 class="mb-0 font-monospace text-primary">${acc.accountNumber || acc.account_number}</h5>
                        </div>
                        <button class="btn btn-primary btn-sm flex-shrink-0" onclick="copyText(this, '${acc.accountNumber || acc.account_number}')">
                            <i class="bi bi-clipboard d-sm-none"></i>
                            <span class="d-none d-sm-inline"><i class="bi bi-clipboard me-1"></i>Copy</span>
                        </button>
                    </div>
                </div>
            `;
        });
    }
    
    html += `
        <div class="alert alert-info border mb-3 waiting-pulse" id="waitingAlert" data-persist="true">
            <small><i class="bi bi-hourglass-split me-1"></i> Waiting for payment...</small>
        </div>
        
        <button class="btn btn-outline-secondary w-100" onclick="closeAccountModal()">
            Close
        </button>
    `;
    
    const modalBody = document.getElementById('modalBody');
    if (modalBody) {
        modalBody.innerHTML = html;
        modalBody.setAttribute('data-no-dismiss', 'true');
    }
    
    const modalEl = document.getElementById('accountModal');
    if (!modalEl) return;
    
    let modal = bootstrap.Modal.getInstance(modalEl);
    
    if (!modal) {
        modal = new bootstrap.Modal(modalEl, {
            backdrop: 'static',
            keyboard: false
        });
    }
    
    modalEl.addEventListener('hidden.bs.modal', function(e) {
        e.stopPropagation();
    });
    
    if (!State.modalShown || !modal._isShown) {
        modal.show();
        State.modalShown = true;
    }
}

function closeAccountModal() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('accountModal'));
    if (modal) {
        modal.hide();
    }
    State.modalShown = false;
}

function cancelQuickTransfer() {
    if (!confirm('Are you sure you want to cancel this transfer?')) return;
    
    stopAllPolling();
    State.quickTransferActive = false;
    State.currentTransactionRef = null;
    clearQuickTransferState();
    
    closeAccountModal();
    
    document.getElementById('quickTransferForm').style.display = 'block';
    document.getElementById('quickTransferDetails').style.display = 'none';
    document.getElementById('quickAmount').value = '';
    
    startGeneralPaymentCheck();
}

function startCountdown(seconds) {
    if (State.countdownInterval) {
        clearInterval(State.countdownInterval);
    }
    
    let remaining = seconds;
    
    function updateDisplay() {
        const countdownEl = document.getElementById('countdown');
        if (!countdownEl) {
            console.warn('Countdown element not found, stopping countdown');
            if (State.countdownInterval) {
                clearInterval(State.countdownInterval);
                State.countdownInterval = null;
            }
            return false;
        }
        
        const minutes = Math.floor(remaining / 60);
        const secs = remaining % 60;
        const display = `${minutes}:${secs.toString().padStart(2, '0')}`;
        
        countdownEl.textContent = display;
        
        if (remaining <= 300) {
            countdownEl.classList.add('countdown-expired');
        }
        
        return true;
    }
    
    if (!updateDisplay()) return;
    
    State.countdownInterval = setInterval(() => {
        remaining--;
        
        if (!updateDisplay()) return;
        
        if (remaining <= 0) {
            handleCountdownExpired();
        }
    }, 1000);
}

function handleCountdownExpired() {
    clearInterval(State.countdownInterval);
    stopAllPolling();
    clearQuickTransferState();
    
    const waitingAlert = document.getElementById('waitingAlert');
    if (waitingAlert) {
        waitingAlert.className = 'alert alert-danger border';
        waitingAlert.innerHTML = '<small><i class="bi bi-x-circle me-1"></i> Transfer expired. Generate new account if needed.</small>';
    }
    
    State.quickTransferActive = false;
    showToast('Transfer window expired', 'warning');
    
    setTimeout(() => {
        closeAccountModal();
        document.getElementById('quickTransferForm').style.display = 'block';
    }, 3000);
}

function startGeneralPaymentCheck() {
    stopAllPolling();
    
    State.pollingInterval = setInterval(async () => {
        try {
            const response = await fetch('/api/check-payment-status/', {
                headers: { 'X-CSRFToken': getCookie('csrftoken') }
            });
            
            if (!response.ok) return;
            
            const data = await response.json();
            
            if (data.success && data.payment_received) {
                handlePaymentReceived(data);
            }
        } catch (error) {
            console.error('Payment check error:', error);
        }
    }, 5000);
}

function startPaymentPolling(transactionRef) {
    stopAllPolling();
    
    State.pollStartTime = Date.now();
    const maxPolls = 480;
    let pollCount = 0;
    
    State.pollingInterval = setInterval(async () => {
        pollCount++;
        
        try {
            const response = await fetch(`/api/check-payment-status/?ref=${transactionRef}`, {
                headers: { 'X-CSRFToken': getCookie('csrftoken') }
            });
            
            if (!response.ok) return;
            
            const data = await response.json();
            
            if (data.success && data.payment_received) {
                stopAllPolling();
                handlePaymentReceived(data);
                return;
            }
            
            if (pollCount >= maxPolls) {
                handleCountdownExpired();
            }
            
        } catch (error) {
            console.error('Polling error:', error);
        }
    }, 5000);
}

function stopAllPolling() {
    if (State.pollingInterval) {
        clearInterval(State.pollingInterval);
        State.pollingInterval = null;
    }
    if (State.countdownInterval) {
        clearInterval(State.countdownInterval);
        State.countdownInterval = null;
    }
}

function handlePaymentReceived(data) {
    stopAllPolling();
    clearQuickTransferState();
    State.quickTransferActive = false;
    
    const amount = parseFloat(data.amount || 0);
    const newBalance = parseFloat(data.new_balance || 0);
    
    const balanceEl = document.querySelector('.card-body.text-center h2');
    if (balanceEl) {
        balanceEl.textContent = `₦${newBalance.toLocaleString('en-NG')}`;
    }
    
    const waitingAlert = document.getElementById('waitingAlert');
    if (waitingAlert) {
        waitingAlert.className = 'alert alert-success border payment-success';
        waitingAlert.innerHTML = `<i class="bi bi-check-circle-fill me-1"></i> <strong>Payment Received!</strong> ₦${amount.toLocaleString()}`;
    }
    
    showToast(`Payment of ₦${amount.toLocaleString()} received!`, 'success');
    
    setTimeout(() => {
        closeAccountModal();
        location.reload();
    }, 3000);
}

function copyText(button, text) {
    if (!navigator.clipboard) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand('copy');
            showCopySuccess(button);
        } catch (err) {
            console.error('Copy failed:', err);
        }
        document.body.removeChild(textarea);
        return;
    }

    navigator.clipboard.writeText(text).then(() => {
        showCopySuccess(button);
        showToast('Copied to clipboard!', 'success');
    }).catch(err => {
        console.error('Copy failed:', err);
    });
}

function showCopySuccess(button) {
    const originalHtml = button.innerHTML;
    const originalClass = button.className;
    
    button.innerHTML = '<i class="bi bi-check-circle-fill"></i>';
    button.className = button.className.replace('btn-primary', 'btn-success').replace('btn-outline-secondary', 'btn-success');
    button.disabled = true;

    setTimeout(() => {
        button.innerHTML = originalHtml;
        button.className = originalClass;
        button.disabled = false;
    }, 2000);
}

function validateBVN(bvn) {
    return /^[0-9]{11}$/.test(bvn);
}

function validateNIN(nin) {
    return /^[0-9]{11}$/.test(nin);
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    if (!container) return;
    
    const icons = {
        'success': 'bi-check-circle-fill',
        'danger': 'bi-x-circle-fill',
        'warning': 'bi-exclamation-triangle-fill',
        'info': 'bi-info-circle-fill'
    };
    
    const bgColors = {
        'success': 'bg-success',
        'danger': 'bg-danger',
        'warning': 'bg-warning',
        'info': 'bg-info'
    };
    
    const toastId = 'toast-' + Date.now();
    const toastEl = document.createElement('div');
    toastEl.id = toastId;
    toastEl.className = 'toast align-items-center text-white border-0';
    toastEl.classList.add(bgColors[type] || bgColors.info);
    toastEl.setAttribute('role', 'alert');
    toastEl.setAttribute('aria-live', 'assertive');
    toastEl.setAttribute('aria-atomic', 'true');
    
    toastEl.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi ${icons[type] || icons.info} me-2"></i>${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    container.appendChild(toastEl);
    
    const toast = new bootstrap.Toast(toastEl, {
        autohide: true,
        delay: 5000
    });
    
    toast.show();
    
    toastEl.addEventListener('hidden.bs.toast', function() {
        toastEl.remove();
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function cleanup() {
    stopAllPolling();
}
</script>
{% endblock %}

{% block 'Footer' %}{% endblock %}