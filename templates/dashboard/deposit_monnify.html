{% extends "base.html" %}
{% load static %}

{% block title %}Fund Account - {{ block.super }}{% endblock %}

{% block 'Body' %}
<div class="container my-4">
    {% if has_virtual_account %}
    <script id="virtualAccountData" type="application/json">
    {
        "account_reference": "{{ virtual_accounts.first.account_reference }}",
        "account_name": "{{ virtual_accounts.first.account_name }}",
        "user_id": "{{ request.user.id }}",
        "accounts": [
            {% for va in virtual_accounts %}
            {
                "bank_name": "{{ va.bank_name }}",
                "account_number": "{{ va.account_number }}",
                "bank_code": "{{ va.bank_code }}"
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
    }
    </script>
    {% endif %}

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-header py-3" style="background-color: var(--primary-color);">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold text-white" style="font-size: 1.35rem;">
                            <i class="bi bi-wallet2 me-2"></i>Fund Your Account
                        </h5>
                        <a href="{% url 'dashboard_home' %}" class="btn btn-light btn-sm">
                            <i class="bi bi-arrow-left me-1"></i>Back
                        </a>
                    </div>
                </div>
            </div>

            <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>

            {% if has_virtual_account %}
                <!-- Active Transfer Alert (when modal is closed) -->
                <div id="activeTransferAlert" class="card border-0 shadow-sm mb-3" style="display: none;">
                    <div class="card-body p-3" style="background-color: var(--warning); border-radius: 0.375rem;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center gap-2">
                                <i class="bi bi-lightning-charge-fill text-dark" style="font-size: 1.5rem;"></i>
                                <div>
                                    <div class="fw-bold text-dark">Active Transfer in Progress</div>
                                    <small class="text-dark" style="opacity: 0.8;">Expires in: <span id="alertCountdown" class="fw-semibold">--:--</span></small>
                                </div>
                            </div>
                            <button class="btn btn-dark btn-sm" onclick="reopenAccountModal()">
                                <i class="bi bi-eye me-1"></i>View Details
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center py-3" style="background-color: var(--success);">
                        <h6 class="mb-0 text-white"><i class="bi bi-bank2 me-2"></i>Your Permanent Account</h6>
                        <span class="badge bg-light" style="color: var(--success);">Active</span>
                    </div>
                    <div class="card-body p-4">
                        <div class="mb-3">
                            <label class="form-label text-muted small fw-bold">ACCOUNT NAME</label>
                            <input type="text" class="form-control bg-body-secondary border-0" value="{{ virtual_accounts.first.account_name }}" readonly>
                        </div>

                        <label class="form-label text-muted small fw-bold mb-2">TRANSFER TO ANY BANK</label>
                        {% for va in virtual_accounts %}
                        <div class="bank-card-custom p-3 rounded mb-2">
                            <div class="d-flex justify-content-between align-items-center gap-3">
                                <div class="flex-grow-1 min-w-0">
                                    <h6 class="mb-2 fw-bold bank-name-text">{{ va.bank_name }}</h6>
                                    <div class="d-flex align-items-center gap-2">
                                        <h5 class="mb-0 font-monospace account-number-text">{{ va.account_number }}</h5>
                                        <button class="btn-copy-custom" onclick="copyText(this, '{{ va.account_number }}')">
                                            <i class="bi bi-copy"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}

                        <div class="deposit-alert deposit-alert-light border mb-0 mt-3">
                            <small class="text-body-secondary">
                                <i class="bi bi-info-circle me-1"></i>
                                Transfer any amount to credit your wallet instantly
                            </small>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-body-secondary py-3" role="button" data-bs-toggle="collapse" data-bs-target="#oneTimeSection">
                        <h6 class="mb-0">
                            <i class="bi bi-lightning-charge-fill me-1" style="color: var(--warning);"></i>One-Time Transfer
                            <i class="bi bi-chevron-down float-end"></i>
                        </h6>
                    </div>
                    <div id="oneTimeSection" class="collapse">
                        <div class="card-body p-4">
                            <div id="quickTransferForm">
                                <p class="text-muted small mb-3">Generate temporary account for single deposit</p>
                                <form onsubmit="generateQuickTransfer(event)">
                                    <div class="mb-3">
                                        <label class="form-label small fw-semibold">Enter Amount</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-white">₦</span>
                                            <input type="number" class="form-control custom-input" id="quickAmount" name="amount" 
                                                   min="100" max="5000000" step="100" placeholder="0.00" required>
                                        </div>
                                        <small class="text-muted d-block mt-1">Min: ₦100 | Max: ₦5,000,000</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label small fw-semibold">Quick Select</label>
                                        <div class="d-flex gap-2 flex-wrap">
                                            <button type="button" class="btn btn-outline-primary quick-amount-btn" onclick="setQuickAmount(1000)">₦1,000</button>
                                            <button type="button" class="btn btn-outline-primary quick-amount-btn" onclick="setQuickAmount(2000)">₦2,000</button>
                                            <button type="button" class="btn btn-outline-primary quick-amount-btn" onclick="setQuickAmount(5000)">₦5,000</button>
                                            <button type="button" class="btn btn-outline-primary quick-amount-btn" onclick="setQuickAmount(10000)">₦10,000</button>
                                        </div>
                                    </div>
                                    
                                    <button type="submit" class="btn w-100" id="generateBtn" style="background-color: var(--warning); color: var(--dark-text-primary); border: none;">
                                        <i class="bi bi-lightning-charge-fill me-1"></i>Generate Transfer Account
                                    </button>
                                </form>
                            </div>
                            <div id="quickTransferDetails" style="display: none;"></div>
                        </div>
                    </div>
                </div>

            {% else %}
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body p-4">
                        <h6 class="mb-3"><i class="bi bi-lightning-charge-fill me-2" style="color: var(--warning);"></i>Quick Transfer</h6>
                        <p class="text-muted small mb-3">Generate temporary account for single deposit</p>
                        
                        <div id="quickTransferForm">
                            <form onsubmit="generateQuickTransfer(event)">
                                <div class="mb-3">
                                    <label class="form-label small fw-semibold">Enter Amount</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-white">₦</span>
                                        <input type="number" class="form-control custom-input" id="quickAmount" name="amount" 
                                               min="100" max="5000000" step="100" placeholder="0.00" required>
                                    </div>
                                    <small class="text-muted d-block mt-1">Min: ₦100 | Max: ₦5,000,000</small>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label small fw-semibold">Quick Select</label>
                                    <div class="d-flex gap-2 flex-wrap">
                                        <button type="button" class="btn btn-outline-primary quick-amount-btn" onclick="setQuickAmount(1000)">₦1,000</button>
                                        <button type="button" class="btn btn-outline-primary quick-amount-btn" onclick="setQuickAmount(2000)">₦2,000</button>
                                        <button type="button" class="btn btn-outline-primary quick-amount-btn" onclick="setQuickAmount(5000)">₦5,000</button>
                                        <button type="button" class="btn btn-outline-primary quick-amount-btn" onclick="setQuickAmount(10000)">₦10,000</button>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn w-100" id="generateBtn" style="background-color: var(--warning); color: var(--dark-text-primary); border: none;">
                                    <i class="bi bi-lightning-charge-fill me-1"></i>Generate Transfer Account
                                </button>
                            </form>
                        </div>
                        <div id="quickTransferDetails" style="display: none;"></div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h6 class="mb-0">
                                <i class="bi bi-bank2 me-2" style="color: var(--primary-color);"></i>Permanent Account
                            </h6>
                            <span class="badge" style="background-color: var(--primary-color);">Recommended</span>
                        </div>
                        <ul class="list-unstyled mb-3 small">
                            <li class="mb-1"><i class="bi bi-check-circle-fill me-2" style="color: var(--success);"></i>One-time setup</li>
                            <li class="mb-1"><i class="bi bi-check-circle-fill me-2" style="color: var(--success);"></i>Reusable anytime</li>
                            <li class="mb-1"><i class="bi bi-check-circle-fill me-2" style="color: var(--success);"></i>Auto-credit deposits</li>
                        </ul>

                        <button class="btn btn-primary w-100 mb-3" data-bs-toggle="collapse" data-bs-target="#permanentForm">
                            <i class="bi bi-bank2 me-2"></i>Create Permanent Account
                        </button>

                        <div id="permanentForm" class="collapse">
                            <div class="deposit-alert deposit-alert-info border-info mb-3 py-2">
                                <small>
                                    <i class="bi bi-shield-check me-1"></i>
                                    Required by Central Bank of Nigeria for account creation
                                </small>
                            </div>

                            <form onsubmit="createPermanentAccount(event)">
                                {% csrf_token %}

                                <div class="btn-group w-100 mb-3" role="group">
                                    <input type="radio" class="btn-check" name="verifyType" id="useBVN" value="bvn" checked>
                                    <label class="btn btn-outline-primary" for="useBVN">BVN</label>

                                    <input type="radio" class="btn-check" name="verifyType" id="useNIN" value="nin">
                                    <label class="btn btn-outline-primary" for="useNIN">NIN</label>

                                    <input type="radio" class="btn-check" name="verifyType" id="useBoth" value="both">
                                    <label class="btn btn-outline-primary" for="useBoth">Both</label>
                                </div>

                                <div id="bvnField" class="mb-3">
                                    <input type="text" class="form-control custom-input" id="bvn" name="bvn" 
                                           maxlength="11" pattern="[0-9]{11}" placeholder="Enter 11-digit BVN" required>
                                    <small class="text-muted d-block mt-1">
                                        <i class="bi bi-phone"></i> Dial *565*0# to get your BVN
                                    </small>
                                </div>

                                <div id="ninField" class="mb-3" style="display: none;">
                                    <input type="text" class="form-control custom-input" id="nin" name="nin" 
                                           maxlength="11" pattern="[0-9]{11}" placeholder="Enter 11-digit NIN">
                                </div>

                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="agreeTerms" required>
                                    <label class="form-check-label small" for="agreeTerms">
                                        I agree to share my BVN/NIN for verification
                                    </label>
                                </div>

                                <button type="submit" class="btn btn-primary w-100" id="createBtn">
                                    <i class="bi bi-bank2 me-2"></i>Create Account
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center py-4">
                    <h6 class="text-muted mb-2 small">Current Balance</h6>
                    <h2 class="mb-0" id="currentBalance" style="color: var(--text-primary);">₦{{ account.balance|floatformat:0 }}</h2>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="accountModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" id="accountModalContent">
            <div class="modal-header" style="background-color: var(--warning);">
                <h5 class="modal-title text-dark"><i class="bi bi-clock-history me-2"></i>Active Transfer Account</h5>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>
</div>

<style>
/* Custom Input Style with theme-aware primary color */
.custom-input {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 0.625rem 0.75rem;
    font-size: 0.95rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.custom-input:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.25rem rgba(0, 51, 102, 0.25);
    outline: 0;
}

[data-bs-theme="dark"] .custom-input:focus {
    box-shadow: 0 0 0 0.25rem rgba(0, 51, 102, 0.4);
}

.custom-input::placeholder {
    color: #adb5bd;
    font-size: 0.95rem;
}

.input-group .input-group-text {
    border: 1px solid #dee2e6;
}

.input-group .custom-input {
    border-left: 0;
}

.input-group:focus-within .input-group-text {
    border-color: var(--primary-color);
}

/* Quick Amount Buttons */
.quick-amount-btn {
    font-size: 0.875rem;
    padding: 0.5rem 1rem;
    border-radius: 0.375rem;
    transition: all 0.2s ease;
}

.quick-amount-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.quick-amount-btn.active {
    background-color: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

/* Custom Bank Card with larger text */
.bank-card-custom {
    background: var(--bs-body-bg);
    border: 1px solid var(--bs-border-color);
    transition: all 0.3s;
}

.bank-card-custom:hover {
    background: var(--bs-secondary-bg);
    border-color: var(--primary-color);
}

.bank-name-text {
    font-size: 1.1rem;
    color: var(--text-primary);
}

.account-number-text {
    font-size: 1.3rem;
    color: var(--primary-color);
}

[data-bs-theme="dark"] .account-number-text {
    color: var(--dark-text-primary);
}

/* Custom Copy Button - Double copy icon style */
.btn-copy-custom {
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    transition: all 0.2s ease;
    color: var(--text-primary);
    font-size: 1.3rem;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-copy-custom:hover {
    transform: scale(1.15);
    color: var(--primary-color);
}

.btn-copy-custom:active {
    transform: scale(0.95);
}

.btn-copy-custom.copied {
    color: var(--success);
}

[data-bs-theme="dark"] .btn-copy-custom {
    color: var(--dark-text-primary);
}

[data-bs-theme="dark"] .btn-copy-custom:hover {
    color: var(--dark-accent-color);
}

.min-w-0 {
    min-width: 0;
}

@media (max-width: 575.98px) {
    .bank-name-text {
        font-size: 1rem;
    }
    
    .account-number-text {
        font-size: 1.15rem;
    }
    
    .btn-copy-custom {
        font-size: 1.15rem;
    }
}

.step-item {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--bs-border-color);
}

.step-item:last-child {
    border-bottom: none;
}

.step-num {
    width: 32px;
    height: 32px;
    background: var(--primary-color);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    flex-shrink: 0;
    font-size: 0.875rem;
}

.toast {
    min-width: 300px;
}

.countdown-timer {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--warning);
}

.countdown-expired {
    color: var(--error);
}

.waiting-pulse {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.payment-success {
    animation: slideDown 0.5s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.deposit-alert {
    padding: 1rem;
    border-radius: 0.375rem;
}

.deposit-alert-primary {
    background-color: var(--bs-primary-bg-subtle);
    border: 1px solid var(--bs-primary-border-subtle);
    color: var(--bs-primary-text-emphasis);
}

.deposit-alert-warning {
    background-color: var(--bs-warning-bg-subtle);
    border: 1px solid var(--bs-warning-border-subtle);
    color: var(--bs-warning-text-emphasis);
}

.deposit-alert-info {
    background-color: var(--bs-info-bg-subtle);
    border: 1px solid var(--bs-info-border-subtle);
    color: var(--bs-info-text-emphasis);
}

.deposit-alert-success {
    background-color: var(--bs-success-bg-subtle);
    border: 1px solid var(--bs-success-border-subtle);
    color: var(--bs-success-text-emphasis);
}

.deposit-alert-danger {
    background-color: var(--bs-danger-bg-subtle);
    border: 1px solid var(--bs-danger-border-subtle);
    color: var(--bs-danger-text-emphasis);
}

/* Modal centering for all screen sizes */
.modal-dialog {
    display: flex;
    align-items: center;
    min-height: calc(100% - 1rem);
}

@media (min-width: 576px) {
    .modal-dialog {
        max-width: 500px;
        margin: 1.75rem auto;
    }
}

@media (max-width: 991.98px) {
    .modal-dialog {
        margin: 1rem auto;
    }
}

@media (max-width: 575.98px) {
    .modal-dialog {
        margin: 0.5rem;
    }
}

.deposit-alert-light {
    background-color: var(--bs-light-bg-subtle);
    border: 1px solid var(--bs-border-color);
    color: var(--bs-body-color);
}
</style>

<script>
const State = {
    pollingInterval: null,
    currentTransactionRef: null,
    pollStartTime: null,
    countdownInterval: null,
    quickTransferActive: false,
    paymentProcessed: false,
    modalShown: false,
    currentUserId: null,
    expiryTime: null,
    savedTransferData: null
};

document.addEventListener('DOMContentLoaded', function() {
    initEventListeners();
    
    const virtualAccountData = document.getElementById('virtualAccountData');
    if (virtualAccountData) {
        try {
            const data = JSON.parse(virtualAccountData.textContent);
            State.currentUserId = data.user_id;
        } catch (e) {
            console.error('Error parsing account data:', e);
        }
    }
    
    setTimeout(() => {
        restoreQuickTransferState();
        startGeneralPaymentCheck();
    }, 200);
});

function initEventListeners() {
    document.querySelectorAll('input[name="verifyType"]').forEach(radio => {
        radio.addEventListener('change', toggleVerificationType);
    });
    
    window.addEventListener('beforeunload', cleanup);
    
    // Persistent countdown updater
    setInterval(() => {
        if (State.quickTransferActive && State.expiryTime) {
            const now = Date.now();
            const remaining = Math.floor((State.expiryTime - now) / 1000);
            
            if (remaining > 0) {
                updateCountdownDisplay(remaining);
                updateAlertCountdown(remaining);
            } else if (remaining <= 0 && !State.paymentProcessed) {
                handleCountdownExpired();
            }
        }
    }, 1000);
}

function setQuickAmount(amount) {
    const input = document.getElementById('quickAmount');
    if (input) {
        input.value = amount;
        input.focus();
        
        document.querySelectorAll('.quick-amount-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
    }
}

function updateCountdownDisplay(seconds) {
    const countdownEl = document.getElementById('countdown');
    if (!countdownEl) return;
    
    const minutes = Math.floor(seconds / 60);
    const secs = seconds % 60;
    const display = `${minutes}:${secs.toString().padStart(2, '0')}`;
    
    countdownEl.textContent = display;
    
    if (seconds <= 300) {
        countdownEl.classList.add('countdown-expired');
    }
}

function updateAlertCountdown(seconds) {
    const alertCountdownEl = document.getElementById('alertCountdown');
    if (!alertCountdownEl) return;
    
    const minutes = Math.floor(seconds / 60);
    const secs = seconds % 60;
    const display = `${minutes}:${secs.toString().padStart(2, '0')}`;
    
    alertCountdownEl.textContent = display;
}

function showActiveTransferAlert() {
    const alert = document.getElementById('activeTransferAlert');
    if (alert && State.quickTransferActive) {
        alert.style.display = 'block';
    }
}

function hideActiveTransferAlert() {
    const alert = document.getElementById('activeTransferAlert');
    if (alert) {
        alert.style.display = 'none';
    }
}

function reopenAccountModal() {
    if (State.savedTransferData && State.quickTransferActive) {
        const now = Date.now();
        const remaining = Math.floor((State.expiryTime - now) / 1000);
        
        if (remaining > 0) {
            showAccountModal(State.savedTransferData, remaining);
            hideActiveTransferAlert();
        }
    }
}

function restoreQuickTransferState() {
    try {
        const savedState = sessionStorage.getItem('quickTransferState');
        if (!savedState) return;
        
        const state = JSON.parse(savedState);
        
        if (state.userId && State.currentUserId && state.userId !== State.currentUserId) {
            console.log('Different user detected, clearing state');
            sessionStorage.removeItem('quickTransferState');
            return;
        }
        
        const now = Date.now();
        const remaining = Math.floor((state.expiryTime - now) / 1000);
        
        if (remaining > 0 && !state.completed) {
            State.quickTransferActive = true;
            State.currentTransactionRef = state.transactionRef;
            State.expiryTime = state.expiryTime;
            State.savedTransferData = state.transferData;
            
            const quickForm = document.getElementById('quickTransferForm');
            if (quickForm) {
                quickForm.style.display = 'none';
            }
            
            showAccountModal(state.transferData, remaining);
            startPaymentPolling(state.transactionRef);
        } else {
            sessionStorage.removeItem('quickTransferState');
        }
    } catch (error) {
        console.error('Error restoring state:', error);
        sessionStorage.removeItem('quickTransferState');
    }
}

function saveQuickTransferState(transactionRef, transferData) {
    try {
        const expiryTime = Date.now() + (40 * 60 * 1000);
        const state = {
            transactionRef: transactionRef,
            transferData: transferData,
            expiryTime: expiryTime,
            completed: false,
            userId: State.currentUserId
        };
        State.expiryTime = expiryTime;
        State.savedTransferData = transferData;
        sessionStorage.setItem('quickTransferState', JSON.stringify(state));
    } catch (error) {
        console.error('Error saving state:', error);
    }
}

function clearQuickTransferState() {
    try {
        sessionStorage.removeItem('quickTransferState');
        State.expiryTime = null;
        State.savedTransferData = null;
        hideActiveTransferAlert();
    } catch (error) {
        console.error('Error clearing state:', error);
    }
}

function toggleVerificationType(event) {
    const bvnField = document.getElementById('bvnField');
    const ninField = document.getElementById('ninField');
    const bvnInput = document.getElementById('bvn');
    const ninInput = document.getElementById('nin');
    
    const type = event.target.value;
    
    if (type === 'bvn') {
        bvnField.style.display = 'block';
        ninField.style.display = 'none';
        bvnInput.required = true;
        ninInput.required = false;
        ninInput.value = '';
    } else if (type === 'nin') {
        bvnField.style.display = 'none';
        ninField.style.display = 'block';
        bvnInput.required = false;
        ninInput.required = true;
        bvnInput.value = '';
    } else {
        bvnField.style.display = 'block';
        ninField.style.display = 'block';
        bvnInput.required = true;
        ninInput.required = true;
    }
}

async function createPermanentAccount(event) {
    event.preventDefault();
    
    const form = event.target;
    const btn = document.getElementById('createBtn');
    const originalText = btn.innerHTML;
    
    const verifyType = form.querySelector('input[name="verifyType"]:checked').value;
    const bvn = form.querySelector('#bvn')?.value.trim() || '';
    const nin = form.querySelector('#nin')?.value.trim() || '';
    
    if ((verifyType === 'bvn' || verifyType === 'both') && !validateBVN(bvn)) {
        showToast('Valid BVN required (11 digits)', 'danger');
        return;
    }
    
    if ((verifyType === 'nin' || verifyType === 'both') && !validateNIN(nin)) {
        showToast('Valid NIN required (11 digits)', 'danger');
        return;
    }
    
    if (!document.getElementById('agreeTerms').checked) {
        showToast('Please agree to terms', 'warning');
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating...';
    
    try {
        const requestData = {};
        if (verifyType === 'bvn' || verifyType === 'both') requestData.bvn = bvn;
        if (verifyType === 'nin' || verifyType === 'both') requestData.nin = nin;
        
        const response = await fetch('/api/create-permanent-account/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(requestData)
        });
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Invalid server response');
        }
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            showToast('Account created successfully!', 'success');
            setTimeout(() => location.reload(), 2000);
        } else {
            showToast(data.message || 'Failed to create account', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Error: ' + error.message, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

async function generateQuickTransfer(event) {
    event.preventDefault();
    
    if (State.quickTransferActive) {
        showToast('Please wait for current transfer to complete or expire', 'warning');
        return;
    }
    
    const form = event.target;
    const amountInput = form.querySelector('#quickAmount');
    const btn = document.getElementById('generateBtn');
    const amount = parseFloat(amountInput.value);
    
    if (isNaN(amount) || amount < 100) {
        showToast('Minimum amount is ₦100', 'danger');
        return;
    }
    
    if (amount > 5000000) {
        showToast('Maximum amount is ₦5,000,000', 'danger');
        return;
    }
    
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';
    
    try {
        const response = await fetch('/api/generate-quick-transfer/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ amount: amount })
        });
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Invalid server response');
        }
        
        const data = await response.json();
        
        if (!response.ok || !data.success) {
            throw new Error(data.message || 'Failed to generate account');
        }
        
        State.quickTransferActive = true;
        State.currentTransactionRef = data.transaction_reference;
        
        saveQuickTransferState(data.transaction_reference, data);
        
        showAccountModal(data, 40 * 60);
        document.getElementById('quickTransferForm').style.display = 'none';
        
        startPaymentPolling(data.transaction_reference);
        
        showToast('Transfer account generated!', 'success');
        
    } catch (error) {
        console.error('Error:', error);
        showToast('Error: ' + error.message, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

function showAccountModal(data, seconds) {
    const accounts = data.accounts || [];
    const amount = data.amount || 0;
    
    const minutes = Math.floor(seconds / 60);
    const secs = seconds % 60;
    const initialDisplay = `${minutes}:${secs.toString().padStart(2, '0')}`;
    
    let html = `
        <div class="deposit-alert deposit-alert-primary text-center mb-3" id="amountDisplay">
            <h6 class="mb-1">Amount to Transfer</h6>
            <h2 class="mb-0">₦${parseFloat(amount).toLocaleString('en-NG', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}</h2>
        </div>
        
        <div id="countdownDisplay" class="deposit-alert deposit-alert-warning text-center mb-3">
            <i class="bi bi-clock me-1"></i> Expires in: <span class="countdown-timer" id="countdown">${initialDisplay}</span>
        </div>
    `;
    
    if (accounts.length > 0) {
        html += `
            <div class="mb-3" id="accountNameDisplay">
                <label class="form-label text-muted small fw-bold">ACCOUNT NAME</label>
                <input type="text" class="form-control bg-body-secondary border-0" value="${data.account_name}" readonly>
            </div>
        `;
        
        accounts.forEach((acc, index) => {
            html += `
                <div class="bank-card-custom p-3 rounded mb-2" id="bankCard${index}">
                    <div class="d-flex justify-content-between align-items-center gap-3">
                        <div class="flex-grow-1 min-w-0">
                            <h6 class="mb-2 fw-bold bank-name-text">${acc.bankName || acc.bank_name}</h6>
                            <div class="d-flex align-items-center gap-2">
                                <h5 class="mb-0 font-monospace account-number-text">${acc.accountNumber || acc.account_number}</h5>
                                <button class="btn-copy-custom" onclick="copyText(this, '${acc.accountNumber || acc.account_number}')">
                                    <i class="bi bi-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
    }
    
    html += `
        <div class="deposit-alert deposit-alert-info border mb-3 waiting-pulse" id="waitingAlert">
            <small><i class="bi bi-hourglass-split me-1"></i> Waiting for payment...</small>
        </div>
        
        <div class="d-grid gap-2">
            <button class="btn btn-danger" onclick="cancelQuickTransfer()">
                <i class="bi bi-x-circle me-1"></i> Cancel Transfer
            </button>
            <button class="btn btn-outline-secondary" onclick="closeAccountModal()">
                <i class="bi bi-eye-slash me-1"></i> Close (Keep Active)
            </button>
        </div>
    `;
    
    const modalBody = document.getElementById('modalBody');
    if (modalBody) {
        modalBody.innerHTML = html;
    }
    
    const modalEl = document.getElementById('accountModal');
    if (!modalEl) return;
    
    let modal = bootstrap.Modal.getInstance(modalEl);
    
    if (!modal) {
        modal = new bootstrap.Modal(modalEl, {
            backdrop: 'static',
            keyboard: false
        });
    }
    
    if (!State.modalShown || !modal._isShown) {
        modal.show();
        State.modalShown = true;
        // Hide alert when showing modal
        hideActiveTransferAlert();
    }
}

function closeAccountModal() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('accountModal'));
    if (modal) {
        modal.hide();
    }
    State.modalShown = false;
    
    // Show alert immediately after closing modal if transfer is still active
    if (State.quickTransferActive) {
        setTimeout(() => {
            showActiveTransferAlert();
        }, 300); // Small delay to ensure modal is fully closed
    }
}

function cancelQuickTransfer() {
    if (!confirm('Are you sure you want to cancel this transfer? You can generate a new one immediately.')) return;
    
    stopAllPolling();
    State.quickTransferActive = false;
    State.currentTransactionRef = null;
    clearQuickTransferState();
    
    closeAccountModal();
    
    const quickForm = document.getElementById('quickTransferForm');
    if (quickForm) {
        quickForm.style.display = 'block';
    }
    
    const quickAmount = document.getElementById('quickAmount');
    if (quickAmount) {
        quickAmount.value = '';
        quickAmount.focus();
    }
    
    showToast('Transfer cancelled. You can generate a new one.', 'info');
    
    startGeneralPaymentCheck();
}

function handleCountdownExpired() {
    if (State.countdownInterval) {
        clearInterval(State.countdownInterval);
    }
    stopAllPolling();
    clearQuickTransferState();
    
    const waitingAlert = document.getElementById('waitingAlert');
    if (waitingAlert) {
        waitingAlert.className = 'deposit-alert deposit-alert-danger border';
        waitingAlert.innerHTML = '<small><i class="bi bi-x-circle me-1"></i> Transfer expired. You can generate a new one.</small>';
    }
    
    State.quickTransferActive = false;
    showToast('Transfer window expired', 'warning');
    
    setTimeout(() => {
        closeAccountModal();
        const quickForm = document.getElementById('quickTransferForm');
        if (quickForm) {
            quickForm.style.display = 'block';
        }
    }, 3000);
}

function startGeneralPaymentCheck() {
    stopAllPolling();
    
    State.pollingInterval = setInterval(async () => {
        try {
            const response = await fetch('/api/check-payment-status/', {
                headers: { 'X-CSRFToken': getCookie('csrftoken') }
            });
            
            if (!response.ok) return;
            
            const data = await response.json();
            
            if (data.success && data.payment_received) {
                handlePaymentReceived(data);
            }
        } catch (error) {
            console.error('Payment check error:', error);
        }
    }, 5000);
}

function startPaymentPolling(transactionRef) {
    stopAllPolling();
    
    State.pollStartTime = Date.now();
    const maxPolls = 480;
    let pollCount = 0;
    
    State.pollingInterval = setInterval(async () => {
        pollCount++;
        
        try {
            const response = await fetch(`/api/check-payment-status/?ref=${transactionRef}`, {
                headers: { 'X-CSRFToken': getCookie('csrftoken') }
            });
            
            if (!response.ok) return;
            
            const data = await response.json();
            
            if (data.success && data.payment_received) {
                stopAllPolling();
                handlePaymentReceived(data);
                return;
            }
            
            if (pollCount >= maxPolls) {
                handleCountdownExpired();
            }
            
        } catch (error) {
            console.error('Polling error:', error);
        }
    }, 5000);
}

function stopAllPolling() {
    if (State.pollingInterval) {
        clearInterval(State.pollingInterval);
        State.pollingInterval = null;
    }
    if (State.countdownInterval) {
        clearInterval(State.countdownInterval);
        State.countdownInterval = null;
    }
}

function handlePaymentReceived(data) {
    stopAllPolling();
    clearQuickTransferState();
    State.quickTransferActive = false;
    State.paymentProcessed = true;
    
    const amount = parseFloat(data.amount || 0);
    const newBalance = parseFloat(data.new_balance || 0);
    
    const balanceEl = document.getElementById('currentBalance');
    if (balanceEl) {
        balanceEl.textContent = `₦${newBalance.toLocaleString('en-NG')}`;
    }
    
    const waitingAlert = document.getElementById('waitingAlert');
    if (waitingAlert) {
        waitingAlert.className = 'deposit-alert deposit-alert-success border payment-success';
        waitingAlert.innerHTML = `<strong><i class="bi bi-check-circle-fill me-1"></i> Payment Received!</strong> ₦${amount.toLocaleString()}`;
    }
    
    showToast(`Payment of ₦${amount.toLocaleString()} received successfully!`, 'success');
    
    setTimeout(() => {
        closeAccountModal();
        const quickForm = document.getElementById('quickTransferForm');
        if (quickForm) {
            quickForm.style.display = 'block';
        }
        location.reload();
    }, 3000);
}

function copyText(button, text) {
    if (!navigator.clipboard) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand('copy');
            showCopySuccess(button);
        } catch (err) {
            console.error('Copy failed:', err);
        }
        document.body.removeChild(textarea);
        return;
    }

    navigator.clipboard.writeText(text).then(() => {
        showCopySuccess(button);
        showToast('Copied to clipboard!', 'success');
    }).catch(err => {
        console.error('Copy failed:', err);
    });
}

function showCopySuccess(button) {
    const originalHtml = button.innerHTML;
    
    button.innerHTML = '<i class="bi bi-check2-all"></i>';
    button.classList.add('copied');

    setTimeout(() => {
        button.innerHTML = originalHtml;
        button.classList.remove('copied');
    }, 2000);
}

function validateBVN(bvn) {
    return /^[0-9]{11}$/.test(bvn);
}

function validateNIN(nin) {
    return /^[0-9]{11}$/.test(nin);
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    if (!container) return;
    
    const icons = {
        'success': 'bi-check-circle-fill',
        'danger': 'bi-x-circle-fill',
        'warning': 'bi-exclamation-triangle-fill',
        'info': 'bi-info-circle-fill'
    };
    
    const bgColors = {
        'success': 'bg-success',
        'danger': 'bg-danger',
        'warning': 'bg-warning',
        'info': 'bg-info'
    };
    
    const toastId = 'toast-' + Date.now();
    const toastEl = document.createElement('div');
    toastEl.id = toastId;
    toastEl.className = 'toast align-items-center text-white border-0';
    toastEl.classList.add(bgColors[type] || bgColors.info);
    toastEl.setAttribute('role', 'alert');
    toastEl.setAttribute('aria-live', 'assertive');
    toastEl.setAttribute('aria-atomic', 'true');
    
    toastEl.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi ${icons[type] || icons.info} me-2"></i>${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    container.appendChild(toastEl);
    
    const toast = new bootstrap.Toast(toastEl, {
        autohide: true,
        delay: 5000
    });
    
    toast.show();
    
    toastEl.addEventListener('hidden.bs.toast', function() {
        toastEl.remove();
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function cleanup() {
    stopAllPolling();
}
</script>
{% endblock %}

{% block 'Footer' %}{% endblock %}